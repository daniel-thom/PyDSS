

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade &mdash; PyDSS 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> PyDSS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sample%20TOML%20files.html">Default simulation settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sample%20TOML%20files.html#default-visualization-settings">Default visualization settings</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#create-a-new-project">Create a new project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#exporting-data">Exporting Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#pre-filtering-export-data">Pre-filtering Export Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#run-a-project">Run a project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#analyze-results">Analyze results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#load-element-classes-and-properties">Load element classes and properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element">Read a dataframe for one element</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element-with-a-specific-option">Read a dataframe for one element with a specific option</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element-with-an-option-matching-a-regular-expression">Read a dataframe for one element with an option matching a regular expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-the-total-value-for-a-property-stored-with-store-values-type-sum">Read the total value for a property stored with <code class="docutils literal notranslate"><span class="pre">store_values_type</span> <span class="pre">=</span> <span class="pre">&quot;sum&quot;</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#find-out-all-options-available-for-a-property">Find out all options available for a property</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#find-out-what-option-values-are-present-for-a-property">Find out what option values are present for a property</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-all-elements">Read a dataframe for all elements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#performance-considerations">Performance Considerations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#estimate-space-required-by-pydss-simulation">Estimate space required by PyDSS simulation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Project%20management.html">Improved project management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Result%20management.html">Enhanced result export features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Dynamic%20visualization%20capabilities.html">Dynamic visualization capabilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html">Frequency sweep plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#gis-plot">GIS plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#histogram-plot">Histogram plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#voltage-sag-plot">Voltage sag plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#time-series-plot">Time series plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#voltage-current-heatmap-plot">Voltage / Current heatmap plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#xy-plots">XY plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Creating%20custom%20dynamic%20plots.html">Development of custom dynamic plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Extended%20controls%20library.html">Extended controls library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../Creating%20custom%20controls.html">Extending PyDSS controllers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../External%20interfaces%20for%20cosimulation.html">External PyDSS interfaces</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html">The socket interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html#the-helics-interface">The HELICS interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html#the-api-interface">The API interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Automated%20comparison%20of%20scenarios.html">Automated scenario comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reports.html">Reports</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#global-settings">Global settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../reports.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reports.html#granularity">Granularity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#export-parameters">Export Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#output-data">Output Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#adding-new-reports">Adding New Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdf-data-format.html">HDF Data Format</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../hdf-data-format.html#layout">Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../hdf-data-format.html#common-metadata">Common Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../hdf-data-format.html#dataset-metadata">Dataset Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../hdf-data-format.html#attributes-per-dataset">Attributes per dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../hdf-data-format.html#metadata-datasets-per-dataset">Metadata datasets per dataset</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../hdf-data-format.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../PyDSS.html">PyDSS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../PyDSS/modules.html">PyDSS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html">PyDSS package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#submodules">Submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.NetworkModifier">PyDSS.NetworkModifier module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.ResultData">PyDSS.ResultData module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.SolveMode">PyDSS.SolveMode module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.common">PyDSS.common module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.config_data">PyDSS.config_data module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dataset_buffer">PyDSS.dataset_buffer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssBus">PyDSS.dssBus module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssCircuit">PyDSS.dssCircuit module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElement">PyDSS.dssElement module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElementFactory">PyDSS.dssElementFactory module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssInstance">PyDSS.dssInstance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssObjectBase">PyDSS.dssObjectBase module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssTransformer">PyDSS.dssTransformer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_fields">PyDSS.element_fields module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_options">PyDSS.element_options module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.exceptions">PyDSS.exceptions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.export_list_reader">PyDSS.export_list_reader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.helics_interface">PyDSS.helics_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.loggers">PyDSS.loggers module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.metrics">PyDSS.metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.naerm">PyDSS.naerm module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.node_voltage_metrics">PyDSS.node_voltage_metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyContrReader">PyDSS.pyContrReader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyDSS">PyDSS.pyDSS module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyLogger">PyDSS.pyLogger module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyPlotReader">PyDSS.pyPlotReader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyResults">PyDSS.pyResults module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_fs_interface">PyDSS.pydss_fs_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_project">PyDSS.pydss_project module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_results">PyDSS.pydss_results module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.registry">PyDSS.registry module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.storage_filters">PyDSS.storage_filters module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.thermal_metrics">PyDSS.thermal_metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.unitDefinations">PyDSS.unitDefinations module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.valiate_settings">PyDSS.valiate_settings module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.value_storage">PyDSS.value_storage module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../PyDSS/PyDSS.html">PyDSS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.Extensions.html">PyDSS.Extensions package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.ProfileManager.html">PyDSS.ProfileManager package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.api.html">PyDSS.api package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.cli.html">PyDSS.cli package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyControllers.html">PyDSS.pyControllers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyPlots.html">PyDSS.pyPlots package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyPostprocessor.html">PyDSS.pyPostprocessor package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.reports.html">PyDSS.reports package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.NetworkModifier">PyDSS.NetworkModifier module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.ResultData">PyDSS.ResultData module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.SolveMode">PyDSS.SolveMode module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.common">PyDSS.common module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.config_data">PyDSS.config_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dataset_buffer">PyDSS.dataset_buffer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssBus">PyDSS.dssBus module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssCircuit">PyDSS.dssCircuit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElement">PyDSS.dssElement module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElementFactory">PyDSS.dssElementFactory module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssInstance">PyDSS.dssInstance module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssObjectBase">PyDSS.dssObjectBase module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssTransformer">PyDSS.dssTransformer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_fields">PyDSS.element_fields module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_options">PyDSS.element_options module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.exceptions">PyDSS.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.export_list_reader">PyDSS.export_list_reader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.helics_interface">PyDSS.helics_interface module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.loggers">PyDSS.loggers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.metrics">PyDSS.metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.naerm">PyDSS.naerm module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.node_voltage_metrics">PyDSS.node_voltage_metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyContrReader">PyDSS.pyContrReader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyDSS">PyDSS.pyDSS module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyLogger">PyDSS.pyLogger module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyPlotReader">PyDSS.pyPlotReader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyResults">PyDSS.pyResults module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_fs_interface">PyDSS.pydss_fs_interface module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_project">PyDSS.pydss_project module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_results">PyDSS.pydss_results module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.registry">PyDSS.registry module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.storage_filters">PyDSS.storage_filters module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.thermal_metrics">PyDSS.thermal_metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.unitDefinations">PyDSS.unitDefinations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.valiate_settings">PyDSS.valiate_settings module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.value_storage">PyDSS.value_storage module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS">Module contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PyDSS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade</h1><div class="highlight"><pre>
<span></span><span class="c1">#**Authors:**</span>
<span class="c1"># Akshay Kumar Jain; Akshay.Jain@nrel.gov</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">opendssdirect</span> <span class="k">as</span> <span class="nn">dss</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">PyDSS.exceptions</span> <span class="kn">import</span> <span class="n">InvalidParameter</span><span class="p">,</span> <span class="n">OpenDssConvergenceError</span>
<span class="kn">from</span> <span class="nn">PyDSS.pyPostprocessor.pyPostprocessAbstract</span> <span class="kn">import</span> <span class="n">AbstractPostprocess</span>
<span class="kn">from</span> <span class="nn">PyDSS.pyPostprocessor.PostprocessScripts.postprocess_voltage_upgrades</span> <span class="kn">import</span> <span class="n">postprocess_voltage_upgrades</span>
<span class="kn">from</span> <span class="nn">PyDSS.utils.utils</span> <span class="kn">import</span> <span class="n">iter_elements</span><span class="p">,</span> <span class="n">check_redirect</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>


<span class="c1"># to get metadata: source bus, substation xfmr information</span>
<div class="viewcode-block" id="get_ckt_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.get_ckt_info">[docs]</a><span class="k">def</span> <span class="nf">get_ckt_info</span><span class="p">():</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Vsources</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
    <span class="n">source_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;source_bus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_bus</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
        <span class="n">bus_names_only</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">buses</span> <span class="ow">in</span> <span class="n">bus_names</span><span class="p">:</span>
            <span class="n">bus_names_only</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buses</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">source_bus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">bus_names_only</span><span class="p">:</span>
            <span class="n">sub_xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;substation_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;xfmr_name&quot;</span><span class="p">:</span> <span class="n">sub_xfmr</span><span class="p">,</span>
                <span class="s2">&quot;xfmr_kva&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kVA</span><span class="p">(),</span>
                <span class="s2">&quot;xfmr_kv&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kV</span><span class="p">(),</span>
                <span class="s2">&quot;bus_names&quot;</span><span class="p">:</span> <span class="n">bus_names_only</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">data_dict</span></div>


<span class="c1"># function to get regulator information</span>
<div class="viewcode-block" id="get_reg_control_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.get_reg_control_info">[docs]</a><span class="k">def</span> <span class="nf">get_reg_control_info</span><span class="p">():</span>
    <span class="n">reg_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">reg_name</span><span class="p">,</span> <span class="s2">&quot;xfmr_name&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">(),</span>
                 <span class="s2">&quot;ptratio&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">PTRatio</span><span class="p">(),</span>
                 <span class="s2">&quot;delay&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Delay</span><span class="p">()}</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_name</span><span class="p">))</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;v_setpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;vreg&quot;</span><span class="p">),</span>  <span class="c1"># this returns a tuple - account in pp</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;v_deadband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">),</span>  <span class="c1"># this returns a tuple - account in pp</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Enabled</span><span class="p">(),</span>  <span class="c1"># this returns a tuple - account in postprocess</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;reg_bus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;reg_bus&quot;</span><span class="p">])</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;bus_num_phases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;bus_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_name&quot;</span><span class="p">]))</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_kva&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kva&quot;</span><span class="p">))</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Wdg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># setting winding to 1, to get kV for winding 1</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kV</span><span class="p">()</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_bus1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;xfmr_bus2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_dict</span></div>


<span class="c1"># function to get capacitor information</span>
<div class="viewcode-block" id="get_capacitor_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.get_capacitor_info">[docs]</a><span class="k">def</span> <span class="nf">get_capacitor_info</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span> <span class="s2">&quot;kv&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kV</span><span class="p">(),</span> <span class="s2">&quot;kvar&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kvar</span><span class="p">()}</span></div>


<div class="viewcode-block" id="get_cap_controls_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.get_cap_controls_info">[docs]</a><span class="k">def</span> <span class="nf">get_cap_controls_info</span><span class="p">():</span>
    <span class="n">ctrl_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;CapControl.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctrl_name</span><span class="p">))</span> <span class="c1">##</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ctrl_name</span><span class="p">,</span>
            <span class="s2">&quot;cap_name&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">(),</span>
            <span class="s2">&quot;offsetting&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">OFFSetting</span><span class="p">(),</span>
            <span class="s2">&quot;onsetting&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">ONSetting</span><span class="p">(),</span>
            <span class="s2">&quot;control_type&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ctratio&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">CTRatio</span><span class="p">(),</span>
            <span class="s2">&quot;ptratio&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">PTRatio</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;cap_name&quot;</span><span class="p">])</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;cap_kvar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kvar</span><span class="p">()</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;cap_kv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kV</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data_dict</span></div>


<div class="viewcode-block" id="AutomatedVoltageUpgrade"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade">[docs]</a><span class="k">class</span> <span class="nc">AutomatedVoltageUpgrade</span><span class="p">(</span><span class="n">AbstractPostprocess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used to determine Voltage Upgrades</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REQUIRED_INPUT_FIELDS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;target_v&quot;</span><span class="p">,</span>
        <span class="s2">&quot;initial_voltage_upper_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;initial_voltage_lower_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_voltage_upper_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_voltage_lower_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nominal_pu_voltage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tps_to_test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;create_topology_plots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reg_control_bands&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reg_v_delta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_regulators&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_ltc_placement&quot;</span><span class="p">,</span>
        <span class="s2">&quot;thermal_scenario_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dssInstance</span><span class="p">,</span> <span class="n">dssSolver</span><span class="p">,</span> <span class="n">dssObjects</span><span class="p">,</span> <span class="n">dssObjectsByClass</span><span class="p">,</span> <span class="n">simulationSettings</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutomatedVoltageUpgrade</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dssInstance</span><span class="p">,</span> <span class="n">dssSolver</span><span class="p">,</span> <span class="n">dssObjects</span><span class="p">,</span> <span class="n">dssObjectsByClass</span><span class="p">,</span> <span class="n">simulationSettings</span><span class="p">,</span> <span class="n">Logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dss</span> <span class="o">=</span> <span class="n">dssInstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span> <span class="o">=</span> <span class="n">dssSolver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_dss_files_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dss_files_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;thermal_scenario_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">get_post_process_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;thermal_scenario_name&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">simulationSettings</span><span class="p">[</span><span class="s2">&quot;Project&quot;</span><span class="p">][</span><span class="s2">&quot;Simulation Type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Snapshot&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;Upgrade post-processors are only supported on Snapshot simulations&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Just send this list as input to the upgrades code via DISCO -  this list may be empty or have as many</span>
        <span class="c1"># paths as the user desires - if empty the mults in the &#39;tps_to_test&#39; input will be used else if non-empty</span>
        <span class="c1"># max and min load mults from the load.dss files will be used. Tne tps to test input should always be specified</span>
        <span class="c1"># irrespective of whether it gets used or not</span>

        <span class="c1"># these parameters are used only if multiple load and pv files are present</span>
        <span class="c1"># TODO: only fixed_tps (using tps_to_test list from config) works in this version</span>
        <span class="c1">#  associated function to compute violations need to be changed to make the multiple dss files option work</span>
        <span class="n">use_fixed_tps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_fixed_tps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="s2">&quot;pydss_other_pvs_dss_files&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="s2">&quot;pydss_other_loads_dss_files&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_load_pv_mults_individual_object</span><span class="p">()</span>  <span class="c1"># multipliers are computed for individual load and pv</span>
            <span class="c1"># self.get_load_mults()  # max and min are taken</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">thermal_filename</span> <span class="o">=</span> <span class="s2">&quot;thermal_upgrades.dss&quot;</span>
        <span class="n">thermal_dss_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;thermal_scenario_path&quot;</span><span class="p">],</span> <span class="n">thermal_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;thermal_dss_file=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">thermal_dss_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">thermal_dss_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AutomatedThermalUpgrade did not produce thermal_filename&quot;</span><span class="p">)</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">thermal_dss_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># reading original objects (before upgrades)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_ckt_info</span> <span class="o">=</span> <span class="n">get_ckt_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_reg_controls</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="p">,</span> <span class="n">get_reg_control_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_capacitors</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="p">,</span> <span class="n">get_capacitor_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_capcontrols</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="p">,</span> <span class="n">get_cap_controls_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_info</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">AllNames</span><span class="p">()</span>

        <span class="c1"># Get feeder head meta data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_bus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_basekv</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">NumNodes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_basekv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_basekv</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Cap bank default settings -</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capON</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capONdelay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capOFFdelay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capdeadtime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PTphase</span> <span class="o">=</span> <span class="s2">&quot;AVG&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_control</span> <span class="o">=</span> <span class="s2">&quot;voltage&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_regs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_regulators&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># TODO: Regs default settings</span>

        <span class="c1"># Substation LTC default settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LTC_setpoint</span> <span class="o">=</span> <span class="mf">1.03</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LTC_wdg</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LTC_delay</span> <span class="o">=</span> <span class="mi">45</span>  <span class="c1"># in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LTC_band</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># deadband in volts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">place_new_regulators</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># flag to determine whether to place new regulators or not</span>

        <span class="c1"># Initialize dss upgrades file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;//This file has all the upgrades determined using the control device placement algorithm </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span>

        <span class="c1"># Get correct source bus and conn type for all downstream regs - since regs are added before DTs and after</span>
        <span class="c1"># sub xfmr - their connection should be same as that of secondary wdg of sub xfmr</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Vsources</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_conn</span> <span class="o">=</span> <span class="s2">&quot;wye&quot;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">xfmr_buses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                    <span class="n">num_wdgs</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">NumWindings</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">wdg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_wdgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reg_conn</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;conn&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># used to determine time taken for run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_nx_representation</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_existing_controller_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_feeder</span><span class="p">()</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_result_comparison_voltages</span><span class="p">(</span><span class="n">comparison_stage</span><span class="o">=</span><span class="s1">&#39;Before Upgrades&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_buses_with_violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span>  <span class="c1"># save initial bus violations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># status - whether voltage upgrades done or not</span>
        <span class="c1"># if there are no buses with violations based on initial check, don&#39;t get into upgrade process</span>
        <span class="c1"># directly go to end of file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Voltage Upgrades Required.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;No Voltage Upgrades needed&#39;</span>  <span class="c1"># status - whether voltage upgrades done or not</span>

        <span class="c1"># else, if there are bus violations based on initial check, start voltage upgrades process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># change voltage checking thresholds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_upper_limit&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_lower_limit&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;Voltage Upgrades were needed&#39;</span>  <span class="c1"># status - whether voltage upgrades done or not</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Voltage Upgrades Required.&quot;</span><span class="p">)</span>
            <span class="c1"># Use this block for capacitor settings</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                <span class="c1"># Correct cap banks settings if caps are present in the feeder</span>
                <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cap bank settings sweep, if capacitors are present.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_capacitor_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">correct_cap_bank_settings</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cap_settings_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No cap banks exist in the system&quot;</span><span class="p">)</span>

            <span class="c1"># Do a settings sweep of existing reg control devices (other than sub LTC) after correcting their other</span>
            <span class="c1">#  parameters such as ratios etc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_sweep_viols</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Settings sweep for existing reg control devices (other than sub LTC).&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_regctrls_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">reg_cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                    <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                    <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># # Skipping over substation LTC if it exists</span>
                    <span class="c1"># for n, d in self.G.in_degree().items():</span>
                    <span class="c1">#     if d==0:</span>
                    <span class="c1">#         sourcebus = n</span>
                    <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                    <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                        <span class="c1"># dss.RegControls.Next()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="n">reg_cnt</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">bus_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus_name</span><span class="p">)</span>
                    <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">kV</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">winding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_wdg</span>
                    <span class="n">reg_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_delay</span>
                    <span class="n">pt_ratio</span> <span class="o">=</span> <span class="n">kV</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Vreg</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;vreg&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">Vreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">3.0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_regctrls_settings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vreg</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">]</span>
                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> transformer=</span><span class="si">{tn}</span><span class="s2"> winding=</span><span class="si">{w}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> ptratio=</span><span class="si">{rt}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> &quot;</span> \
                                     <span class="s2">&quot;enabled=true delay=</span><span class="si">{d}</span><span class="s2"> !original&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rn</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">tn</span><span class="o">=</span><span class="n">xfmr</span><span class="p">,</span>
                        <span class="n">w</span><span class="o">=</span><span class="n">winding</span><span class="p">,</span>
                        <span class="n">sp</span><span class="o">=</span><span class="n">Vreg</span><span class="p">,</span>
                        <span class="n">rt</span><span class="o">=</span><span class="n">pt_ratio</span><span class="p">,</span>
                        <span class="n">b</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
                        <span class="n">d</span><span class="o">=</span><span class="n">reg_delay</span>
                    <span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="c1"># add this to a dss_upgrades.dss file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reg_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reg_sweep_viols</span><span class="p">[</span><span class="s2">&quot;original&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reg_controls_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>

            <span class="c1"># Writing out the results before adding new devices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades to dss file, before adding new devices.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">()</span>
            <span class="c1"># TODO: decide whether postprocess should be done once before going to next stage of adding objects</span>
            <span class="c1"># postprocess_voltage_upgrades(</span>
            <span class="c1">#     {</span>
            <span class="c1">#         &quot;outputs&quot;: self.config[&quot;Outputs&quot;],</span>
            <span class="c1">#         &quot;feederhead_name&quot;: self.feeder_head_name,</span>
            <span class="c1">#         &quot;feederhead_basekV&quot;: self.feeder_head_basekv</span>
            <span class="c1">#     },</span>
            <span class="c1">#     self.logger,</span>
            <span class="c1"># )</span>

            <span class="c1"># New devices might be added after this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="s2">&quot;pre_reg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_added_flag</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Use this block for adding a substation LTC, correcting its settings and running a sub LTC settings sweep -</span>
            <span class="c1"># if LTC exists first try to correct its non set point simulation settings - if this does not correct everything</span>
            <span class="c1">#  correct its set points through a sweep - if LTC does not exist add one including a xfmr if required - then</span>
            <span class="c1">#  do a settings sweep if required</span>
            <span class="c1"># self.add_ctrls_flag = 0</span>
            <span class="c1"># TODO: If adding a substation LTC increases violations even after the control sweep then before then remove it</span>
            <span class="c1"># TODO: - this might however interfere with voltage regulator logic so may be let it be there</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;use_ltc_placement&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add/Correct/Sweep settings for Substation LTC.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                    <span class="c1"># Add substation LTC if not available (may require addition of a new substation xfmr as well)</span>
                    <span class="c1"># if available correct its settings</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subLTC_sweep_viols</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">LTC_exists_flag</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initial_subLTC_settings</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                            <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                            <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                            <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># for n, d in self.G.in_degree().items():</span>
                            <span class="c1">#     if d==0:</span>
                            <span class="c1">#         sourcebus = n</span>
                            <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                            <span class="c1"># Skipping over all reg controls other than sub LTC</span>
                            <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">LTC_exists_flag</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                                <span class="n">bus_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus_name</span><span class="p">)</span>
                                <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                                <span class="n">kV</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                                <span class="n">winding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_wdg</span>
                                <span class="n">reg_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_delay</span>
                                <span class="n">pt_ratio</span> <span class="o">=</span> <span class="n">kV</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">])</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">Vreg</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;vreg&quot;</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">Vreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">3.0</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">initial_subLTC_settings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vreg</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">]</span>
                                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> transformer=</span><span class="si">{tn}</span><span class="s2"> winding=</span><span class="si">{w}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> ptratio=</span><span class="si">{rt}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> &quot;</span> \
                                                 <span class="s2">&quot;enabled=true delay=</span><span class="si">{d}</span><span class="s2"> !original&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">rn</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">tn</span><span class="o">=</span><span class="n">xfmr</span><span class="p">,</span>
                                    <span class="n">w</span><span class="o">=</span><span class="n">winding</span><span class="p">,</span>
                                    <span class="n">sp</span><span class="o">=</span><span class="n">Vreg</span><span class="p">,</span>
                                    <span class="n">rt</span><span class="o">=</span><span class="n">pt_ratio</span><span class="p">,</span>
                                    <span class="n">b</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
                                    <span class="n">d</span><span class="o">=</span><span class="n">reg_delay</span>
                                <span class="p">)</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                                <span class="c1"># add this to a dss_upgrades.dss file</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_exists_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subLTC_sweep_viols</span><span class="p">[</span><span class="s2">&quot;original&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">LTC_controls_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">create_final_comparison</span><span class="p">(</span><span class="n">project_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_dss_files_path&quot;</span><span class="p">],</span>
                                                             <span class="n">thermal_dss_file</span><span class="o">=</span><span class="n">thermal_dss_file</span><span class="p">)</span>
                                <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                                    <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># TODO</span>
                                <span class="c1"># TODO: pass flag to be used: if pass_flag is false, just go to create comparison file</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_exists_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_substation_LTC</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="s2">&quot;sub_LTC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_added_flag</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">LTC_controls_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                                <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                                    <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="c1"># TODO: this pass flag is to be used:</span>
                                <span class="c1">#  if pass_flag is false, then just go to create comparison file</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_substation_LTC</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="s2">&quot;sub_LTC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_added_flag</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">LTC_controls_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>

            <span class="c1"># Correct regulator settings if regs are present in the feeder other than the sub station LTC</span>
            <span class="c1"># TODO: Remove regs of last iteration</span>
            <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># TODO</span>
            <span class="c1"># TODO: pass flag to be used: if pass_flag is false, then just go to create comparison file</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of buses in circuit: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># if number of buses with violations is very high, the loop for adding new regulators will take very long</span>
            <span class="c1"># so disable this block - current condition is if number of violations &gt; 250</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_buses_with_violations</span><span class="p">)),</span> <span class="mi">500</span><span class="p">,</span>
                                                     <span class="nb">len</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">())</span>
                                                     <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At this point, number of buses with violations is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; but initial number of buses with violations is &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_buses_with_violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;So disable option for addition of new regulators&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">place_new_regulators</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># if option to place new regulators is disabled</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_new_regulators</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ignoring block for adding new regulators&quot;</span><span class="p">)</span>
                <span class="c1"># determining key with minimum objective func. at various levels</span>
                <span class="c1"># (at this point includes pre-reg, sub-LTC)</span>
                <span class="n">min_cluster</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">min_severity</span> <span class="o">=</span> <span class="mi">1000000000</span>
                <span class="c1"># TODO - below logic for min_severity was used previously - however, error cases were encountered</span>
                <span class="c1">#  for some feeders due to min_severity being not large enough</span>
                <span class="c1"># min_severity = pow(len(self.all_bus_names), 2) * len(self.config[&quot;tps_to_test&quot;]) * self.upper_limit</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_severity</span><span class="p">:</span>
                        <span class="n">min_severity</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">min_cluster</span> <span class="o">=</span> <span class="n">key</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking objective function to determine best possible upgrades.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;At stages: 1) Before addition of new devices. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;2) With Substation LTC.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_objective_function</span><span class="p">(</span><span class="n">min_cluster</span><span class="p">)</span>

            <span class="c1"># if option to place new regulators is enabled</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">place_new_regulators</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
                <span class="c1"># for n, d in self.G.in_degree().items():</span>
                <span class="c1">#     if d == 0:</span>
                <span class="c1">#         self.source = n</span>
                <span class="c1"># Place additional regulators if required</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sweep by placing additional regulators&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of buses with violations:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_regs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_regulators&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_shortest_path</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_full_distance_dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_square_array</span><span class="p">()</span>
                <span class="n">min_severity</span> <span class="o">=</span> <span class="mi">1000000000</span>
                <span class="c1"># TODO - below logic for min_severity was used previously - however, error cases were encountered</span>
                <span class="c1">#  for some feeders due to min_severity being not large enough</span>
                <span class="c1"># min_severity = pow(len(self.all_bus_names), 2) * len(self.config[&quot;tps_to_test&quot;]) * self.upper_limit</span>

                <span class="c1">#  determining key with minimum objective func. at various levels</span>
                <span class="c1"># (at this point includes pre-reg, sub-LTC, and all newly added regulators)</span>
                <span class="n">min_cluster</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_severity</span><span class="p">:</span>
                        <span class="n">min_severity</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">min_cluster</span> <span class="o">=</span> <span class="n">key</span>
                <span class="c1"># Logic is if violations were less before addition of any device, revert back to that condition by removing</span>
                <span class="c1">#  added LTC and not adding best determined in-line regs, else if LTC was best - pass and do not add new</span>
                <span class="c1">#  in-line regs, or if some better LTC placemenr was determined apply that</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking objective function to determine best possible upgrades.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;At stages: 1) Before addition of new devices. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;2) With Substation LTC. 3) With newly added regulators&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_objective_function</span><span class="p">(</span><span class="n">min_cluster</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compare objective with best and applied settings, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="n">min_cluster</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Additional regctrl  devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">min_cluster</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cluster_optimal_reg_nodes=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># used to determine time taken for run</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_final_comparison</span><span class="p">(</span><span class="n">project_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_dss_files_path&quot;</span><span class="p">],</span> <span class="n">thermal_dss_file</span><span class="o">=</span><span class="n">thermal_dss_file</span><span class="p">)</span>

        <span class="c1"># go to voltage upgrades post processing script</span>
        <span class="n">postprocess_voltage_upgrades</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span>
                <span class="s2">&quot;feederhead_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_name</span><span class="p">,</span>
                <span class="s2">&quot;feederhead_basekV&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_basekv</span><span class="p">,</span>
                <span class="s2">&quot;orig_ckt_info&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_ckt_info</span><span class="p">,</span>
                <span class="s2">&quot;new_reg_controls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_reg_controls</span><span class="p">,</span>
                <span class="s2">&quot;orig_reg_controls&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_reg_controls</span><span class="p">,</span>
                <span class="s2">&quot;new_capacitors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_capacitors</span><span class="p">,</span>
                <span class="s2">&quot;orig_capacitors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_capacitors</span><span class="p">,</span>
                <span class="s2">&quot;new_capcontrols&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_capcontrols</span><span class="p">,</span>
                <span class="s2">&quot;orig_capcontrols&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_capcontrols</span><span class="p">,</span>
                <span class="s2">&quot;orig_xfmr_info&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_info</span><span class="p">,</span>
                <span class="s2">&quot;new_xfmr_info&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_xfmr_info</span><span class="p">,</span>
                <span class="s2">&quot;new_ckt_info&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_ckt_info</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Convergence</span><span class="p">()</span>  <span class="c1"># TODO This is fake for now, find how to get this from Opendssdirect</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_required_input_fields</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">AutomatedVoltageUpgrade</span><span class="o">.</span><span class="n">REQUIRED_INPUT_FIELDS</span>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.create_final_comparison"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.create_final_comparison">[docs]</a>    <span class="k">def</span> <span class="nf">create_final_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thermal_dss_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing upgrades to DSS file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking impact of redirected upgrades file&quot;</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;Clear&quot;</span><span class="p">)</span>
        <span class="n">base_dss</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Settings</span><span class="p">[</span><span class="s2">&quot;Project&quot;</span><span class="p">][</span><span class="s2">&quot;DSS File&quot;</span><span class="p">])</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">base_dss</span><span class="p">)</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">thermal_dss_file</span><span class="p">)</span>
        <span class="n">upgrades_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;voltage_upgrades.dss&quot;</span><span class="p">)</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">upgrades_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_reg_controls</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="p">,</span> <span class="n">get_reg_control_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_capacitors</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="p">,</span> <span class="n">get_capacitor_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_capcontrols</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="p">,</span> <span class="n">get_cap_controls_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_xfmr_info</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">AllNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_ckt_info</span> <span class="o">=</span> <span class="n">get_ckt_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_result_comparison_voltages</span><span class="p">(</span><span class="n">comparison_stage</span><span class="o">=</span><span class="s1">&#39;After Upgrades&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;Simulation time (seconds)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;Upgrade status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;feederhead_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;feederhead_basekV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feeder_head_basekv</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">,</span> <span class="s2">&quot;Voltage_violations_comparison&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># this function create comparison file</span>
<div class="viewcode-block" id="AutomatedVoltageUpgrade.create_result_comparison_voltages"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.create_result_comparison_voltages">[docs]</a>    <span class="k">def</span> <span class="nf">create_result_comparison_voltages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comparison_stage</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># If initial and final limits are different,</span>
        <span class="c1"># also doing with final limits to get comparison between initial and final violation numbers</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_upper_limit&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_voltage_upper_limit&quot;</span><span class="p">])</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_lower_limit&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_voltage_lower_limit&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial and Final voltage limits are not the same. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">initial_voltage_lower_limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_voltage_lower_limit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;initial_voltage_upper_limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;initial_voltage_upper_limit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">final_voltage_lower_limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;final_voltage_lower_limit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;final_voltage_upper_limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;final_voltage_upper_limit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_upper_limit&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;final_voltage_lower_limit&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Based on Lower limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="si">}</span><span class="s2">, Upper limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> number of buses with violations are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span>
                                                                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> objective function value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_violations_2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Voltage upper threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                <span class="s2">&quot;Voltage lower threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                <span class="s2">&quot;Number of buses with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">),</span>
                <span class="s2">&quot;Number of buses with overvoltage violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">),</span>
                <span class="s2">&quot;Number of buses with undervoltage violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">),</span>
                <span class="s2">&quot;Buses at all tps with violations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;Severity of bus violations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;Objective function value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;Maximum voltage observed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span>
                <span class="s2">&quot;Minimum voltage observed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span>
            <span class="p">}</span>

        <span class="c1"># change violation checking thresholds to initial limit - to ensure uniform comparison betn initial &amp; final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_voltage_upper_limit&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;initial_voltage_lower_limit&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> maximum voltage observed on any node: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span>
                                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> minimum voltage observed on any node: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Based on Lower limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="si">}</span><span class="s2">, Upper limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> number of buses with violations are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span>
                                                                             <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> objective function value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_violations&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comparison_stage</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Voltage upper threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
            <span class="s2">&quot;Voltage lower threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
            <span class="s2">&quot;Number of buses with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">),</span>
            <span class="s2">&quot;Number of buses with overvoltage violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">),</span>
            <span class="s2">&quot;Number of buses with undervoltage violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">),</span>
            <span class="s2">&quot;Buses at all tps with violations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;Severity of bus violations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;Objective function value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;Maximum voltage observed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span>
            <span class="s2">&quot;Minimum voltage observed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span>
        <span class="p">}</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_load_pv_mults_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_load_pv_mults_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_load_pv_mults_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">kW</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kW</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_load_files_individual_object</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">pmpp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;irradiance&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pmpp</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_pv_files_individual_object</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.read_load_files_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.read_load_files_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">read_load_files_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key_paths</span><span class="p">,</span><span class="n">dss_path</span><span class="p">):</span>
        <span class="c1"># Add all load kW values</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path_f</span> <span class="ow">in</span> <span class="n">dss_path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new load.&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">):</span>
                                <span class="n">ld_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;kw&quot;</span><span class="p">):</span>
                                <span class="n">ld_kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">temp_dict</span><span class="p">[</span><span class="n">ld_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ld_kw</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.read_pv_files_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.read_pv_files_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">read_pv_files_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_paths</span><span class="p">,</span> <span class="n">dss_path</span><span class="p">):</span>
        <span class="c1"># Add all PV pmpp values</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path_f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span><span class="p">[</span><span class="n">key_paths</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new pvsystem.&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pvsystem.&quot;</span><span class="p">):</span>
                                <span class="n">pv_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;pvsystem.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;irradiance&quot;</span><span class="p">):</span>
                                <span class="n">pv_pmpp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">temp_dict</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_pmpp</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_load_mults"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_load_mults">[docs]</a>    <span class="k">def</span> <span class="nf">get_load_mults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">kW</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kW</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">dss_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_load_files</span><span class="p">(</span><span class="n">dss_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_min_max_load_mult</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.read_load_files"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.read_load_files">[docs]</a>    <span class="k">def</span> <span class="nf">read_load_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dss_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dss_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new load.&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">):</span>
                            <span class="n">ld_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;kw&quot;</span><span class="p">):</span>
                            <span class="n">ld_kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ld_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">ld_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ld_kw</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_min_max_load_mult"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_min_max_load_mult">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_max_load_mult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.compare_objective_function"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.compare_objective_function">[docs]</a>    <span class="k">def</span> <span class="nf">compare_objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_cluster</span><span class="p">):</span>
        <span class="c1"># Logic is if violations were less before addition of any device, revert back to that condition by removing</span>
        <span class="c1">#  added LTC and not adding best determined in-line regs, else if LTC was best - pass and do not add new</span>
        <span class="c1">#  in-line regs, or if some better LTC placement was determined apply that</span>
        <span class="k">if</span> <span class="n">min_cluster</span> <span class="o">==</span> <span class="s2">&quot;pre_reg&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Violations were less before addition of any new regulator or substation LTC.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Remove substation LTC and best in-line reg.&quot;</span><span class="p">)</span>
            <span class="c1"># This will remove LTC controller, but if initially there was no substation transformer</span>
            <span class="c1"># (highly unlikely) the added transformer will still be there</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_added_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">LTC_reg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">LTC_reg_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_bus</span>
                <span class="n">LTC_name</span> <span class="o">=</span> <span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">LTC_reg_node</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{ltc_nm}</span><span class="s2"> enabled=False&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ltc_nm</span><span class="o">=</span><span class="n">LTC_name</span>
                <span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">min_cluster</span> <span class="o">==</span> <span class="s2">&quot;sub_LTC&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting with substation LTC is best.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting with new regulator placement is best.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">reg_nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="n">min_cluster</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_new_xfmr</span><span class="p">(</span><span class="n">reg_nodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_new_regctrl</span><span class="p">(</span><span class="n">reg_nodes</span><span class="p">)</span>
                <span class="n">rn_name</span> <span class="o">=</span> <span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">reg_nodes</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{vsp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">rn</span><span class="o">=</span><span class="n">rn_name</span><span class="p">,</span>
                    <span class="n">vsp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="n">min_cluster</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="n">min_cluster</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="c1"># After all additional devices have been placed perform the cap bank settings sweep again-</span>
            <span class="c1"># only if new devices were accepted</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Violations still exist -&gt; Sweep capacitor settings again, &quot;</span>
                                 <span class="s2">&quot;after new devices are placed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_settings_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_existing_controller_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_existing_controller_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_existing_controller_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_control_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">cap_bank_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cap_ctrl</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">cap_bank_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cap_name</span><span class="p">)</span>
                <span class="n">ctrl_type</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="n">on_setting</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">ONSetting</span><span class="p">()</span>
                <span class="n">off_setting</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">OFFSetting</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">cap_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cap_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;Incorrect Active Element&quot;</span><span class="p">)</span>
                <span class="n">cap_size</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kvar</span><span class="p">()</span>
                <span class="n">cap_kv</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kV</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_info</span><span class="p">[</span><span class="n">cap_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;cap_name&quot;</span><span class="p">:</span> <span class="n">cap_name</span><span class="p">,</span>
                    <span class="s2">&quot;cap kVAR&quot;</span><span class="p">:</span> <span class="n">cap_size</span><span class="p">,</span>
                    <span class="s2">&quot;cap_kv&quot;</span><span class="p">:</span> <span class="n">cap_kv</span><span class="p">,</span>
                    <span class="s2">&quot;Control type&quot;</span><span class="p">:</span> <span class="n">ctrl_type</span><span class="p">,</span>
                    <span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="n">on_setting</span><span class="p">,</span>
                    <span class="s2">&quot;OFF&quot;</span><span class="p">:</span> <span class="n">off_setting</span>
                <span class="p">}</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;CapControl.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap_ctrl</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">reg_ctrl</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">))</span> <span class="c1">##</span>
                <span class="n">reg_vsp</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;vreg&quot;</span><span class="p">)</span>
                <span class="n">reg_band</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
                <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">xfmr_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">xfmr_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;Incorrect Active Element&quot;</span><span class="p">)</span>
                <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                <span class="c1"># bus_names = []</span>
                <span class="c1"># for buses in xfmr_buses:</span>
                <span class="c1">#     bus_names.append(buses.split(&quot;.&quot;)[0].lower())</span>
                <span class="c1"># if self.source.lower() in bus_names:</span>
                <span class="c1">#     self.sub_xfmr_cap = 1</span>
                <span class="n">xfmr_size</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kVA</span><span class="p">()</span>
                <span class="n">xfmr_kv</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kV</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_control_info</span><span class="p">[</span><span class="n">reg_ctrl</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;reg_vsp&quot;</span><span class="p">:</span> <span class="n">reg_vsp</span><span class="p">,</span>
                    <span class="s2">&quot;reg_band&quot;</span><span class="p">:</span> <span class="n">reg_band</span><span class="p">,</span>
                    <span class="s2">&quot;xfmr_name&quot;</span><span class="p">:</span> <span class="n">xfmr_name</span><span class="p">,</span>
                    <span class="s2">&quot;xfmr kVA&quot;</span><span class="p">:</span> <span class="n">xfmr_size</span><span class="p">,</span>
                    <span class="s2">&quot;xfmr_kv&quot;</span><span class="p">:</span> <span class="n">xfmr_kv</span>
                <span class="p">}</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;RegControl.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># if self.sub_xfmr_cap==0:</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
            <span class="n">bus_names_only</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">buses</span> <span class="ow">in</span> <span class="n">bus_names</span><span class="p">:</span>
                <span class="n">bus_names_only</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buses</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">bus_names_only</span><span class="p">:</span>
                <span class="n">sub_xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_control_info</span><span class="p">[</span><span class="s2">&quot;orig_substation_xfmr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;xfmr_name&quot;</span><span class="p">:</span> <span class="n">sub_xfmr</span><span class="p">,</span>
                    <span class="s2">&quot;xfmr kVA&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kVA</span><span class="p">(),</span>
                    <span class="s2">&quot;xfmr_kv&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">kV</span><span class="p">(),</span>
                    <span class="s2">&quot;bus_names&quot;</span><span class="p">:</span> <span class="n">bus_names_only</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">cap_size</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kvar</span><span class="p">()</span>
                <span class="n">cap_kv</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">kV</span><span class="p">()</span>
                <span class="n">ctrl_type</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
                <span class="k">if</span> <span class="n">cap_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cap_bank_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_info</span><span class="p">[</span><span class="s2">&quot;capbank_noctrl_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cap_name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;cap_name&quot;</span><span class="p">:</span> <span class="n">cap_name</span><span class="p">,</span>
                        <span class="s2">&quot;cap kVAR&quot;</span><span class="p">:</span> <span class="n">cap_size</span><span class="p">,</span>
                        <span class="s2">&quot;cap_kv&quot;</span><span class="p">:</span> <span class="n">cap_kv</span><span class="p">,</span>
                        <span class="s2">&quot;Control type&quot;</span><span class="p">:</span> <span class="n">ctrl_type</span>
                    <span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_control_info</span><span class="p">,</span> <span class="s2">&quot;Initial_capacitors&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_control_info</span><span class="p">,</span> <span class="s2">&quot;Initial_regulators&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.write_to_json"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.write_to_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.generate_nx_representation"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.generate_nx_representation">[docs]</a>    <span class="k">def</span> <span class="nf">generate_nx_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_edges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correct_node_coords</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.correct_node_coords"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.correct_node_coords">[docs]</a>    <span class="k">def</span> <span class="nf">correct_node_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If node doesn&#39;t have node attributes, attach parent or child node&#39;s attributes</span>
        <span class="n">new_temp_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">temp_graph</span> <span class="o">=</span> <span class="n">new_temp_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
        <span class="c1"># for n, d in self.G.in_degree().items():</span>
        <span class="c1">#     if d == 0:</span>
        <span class="c1">#         self.source = n</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">new_x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">new_y</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pred_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">pred_buses</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">new_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">new_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Since either predecessor nodes were not available or they did not have</span>
                    <span class="c1"># non-zero coordinates, try successor nodes</span>
                    <span class="c1"># Get a leaf node</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">leaf_node</span> <span class="o">=</span> <span class="n">x</span>
                            <span class="k">break</span>
                    <span class="n">succ_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">leaf_node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">succ_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">succ_buses</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                                <span class="n">new_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                                <span class="k">break</span>
        <span class="c1"># Update pos dict with new coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.generate_nodes"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.generate_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">generate_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">())</span>
            <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.generate_edges"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.generate_edges">[docs]</a>    <span class="k">def</span> <span class="nf">generate_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All lines, switches, reclosers etc are modeled as lines, so calling lines takes care of all of them.</span>
<span class="sd">        However we also need to loop over transformers as they form the edge between primary and secondary nodes</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">1609.34</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">304.8</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">0.3048</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">0.0254</span>
            <span class="k">elif</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">0.01</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
            <span class="n">from_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">to_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.plot_feeder"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.plot_feeder">[docs]</a>    <span class="k">def</span> <span class="nf">plot_feeder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ldn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                     <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                    <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feeder with all customers having DPV systems&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="c1"># (not used) check voltage violations when we have multipliers for individual load and PV</span>
<div class="viewcode-block" id="AutomatedVoltageUpgrade.check_voltage_violations_multi_tps_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.check_voltage_violations_multi_tps_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">check_voltage_violations_multi_tps_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">):</span>
        <span class="c1"># TODO: This objective currently gives more weightage if same node has violations at more than 1 time point</span>
        <span class="n">num_nodes_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">severity_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># If multiple load files are being used, the &#39;tps_to_test property is not used, else if a single load file is</span>
        <span class="c1"># used use the &#39;tps to test&#39; input</span>
        <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)):</span>
            <span class="c1"># Apply correct pmpp values to all PV systems</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;PV system not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_pmpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit PVsystem.</span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> irradiance=</span><span class="si">{</span><span class="n">new_pmpp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Apply correct kW value to all loads</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades till this step in debug_upgrades.dss&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># Select that bus voltage of the three phases which is outside bounds the most,</span>
                <span class="c1">#  else if everything is within bounds use nominal pu voltage.</span>
                <span class="n">maxv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">minv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">:</span>
                    <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="n">maxv_dev</span> <span class="o">=</span> <span class="n">maxv</span> <span class="o">-</span> <span class="n">upper_limit</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lower_limit</span><span class="p">:</span>
                    <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="n">minv_dev</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">-</span> <span class="n">minv</span>
                <span class="k">if</span> <span class="n">maxv_dev</span> <span class="o">&gt;</span> <span class="n">minv_dev</span><span class="p">:</span>
                    <span class="n">v_used</span> <span class="o">=</span> <span class="n">maxv</span>
                    <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">maxv_dev</span>
                    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">elif</span> <span class="n">minv_dev</span> <span class="o">&gt;</span> <span class="n">maxv_dev</span><span class="p">:</span>
                    <span class="n">v_used</span> <span class="o">=</span> <span class="n">minv</span>
                    <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">minv_dev</span>
                    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_pu_voltage&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_used</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_used</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_nodes_counter</span><span class="p">,</span> <span class="n">severity_counter</span><span class="p">,</span> <span class="n">num_nodes_counter</span> <span class="o">*</span> <span class="n">severity_counter</span><span class="p">]</span>
        <span class="k">return</span></div>

    <span class="c1"># this function checks for voltage violations based on upper and lower limit passed</span>
<div class="viewcode-block" id="AutomatedVoltageUpgrade.check_voltage_violations_multi_tps"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.check_voltage_violations_multi_tps">[docs]</a>    <span class="k">def</span> <span class="nf">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># TODO: This objective currently gives more weightage if same node has violations at more than 1 time point</span>
        <span class="n">num_nodes_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">severity_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># If multiple load files are being used, the &#39;tps_to_test property is not used, else if a single load file is</span>
        <span class="c1"># used use the &#39;tps to test&#39; input</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Select that bus voltage of the three phases which is outside bounds the most,</span>
                    <span class="c1">#  else if everything is within bounds use nominal pu voltage.</span>
                    <span class="n">maxv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">minv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">:</span>
                        <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">maxv_dev</span> <span class="o">=</span> <span class="n">maxv</span> <span class="o">-</span> <span class="n">upper_limit</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lower_limit</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">minv_dev</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">-</span> <span class="n">minv</span>
                    <span class="k">if</span> <span class="n">maxv_dev</span> <span class="o">&gt;</span> <span class="n">minv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">maxv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">maxv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">minv_dev</span> <span class="o">&gt;</span> <span class="n">maxv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">minv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">minv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_pu_voltage&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_used</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_used</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Select that bus voltage of the three phases which is outside bounds the most,</span>
                    <span class="c1">#  else if everything is within bounds use nominal pu voltage.</span>
                    <span class="n">maxv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">minv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">:</span>
                        <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">maxv_dev</span> <span class="o">=</span> <span class="n">maxv</span> <span class="o">-</span> <span class="n">upper_limit</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lower_limit</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">minv_dev</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">-</span> <span class="n">minv</span>
                    <span class="k">if</span> <span class="n">maxv_dev</span> <span class="o">&gt;</span> <span class="n">minv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">maxv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">maxv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">minv_dev</span> <span class="o">&gt;</span> <span class="n">maxv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">minv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">minv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_pu_voltage&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_used</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_used</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_nodes_counter</span><span class="p">,</span> <span class="n">severity_counter</span><span class="p">,</span> <span class="n">num_nodes_counter</span> <span class="o">*</span> <span class="n">severity_counter</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.plot_violations"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.plot_violations">[docs]</a>    <span class="k">def</span> <span class="nf">plot_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#plt.figure(figsize=(8, 7))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">numV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of buses in the feeder with voltage violations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numV</span><span class="p">))</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="c1"># Show buses with violations</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span><span class="p">,</span>
                                       <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span><span class="s2">&quot;Nodal_violations_</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span><span class="o">+=</span><span class="mi">1</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_capacitor_state"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_capacitor_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_capacitor_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: How to figure out whether cap banks are 3 phase, 2 phase or 1 phase. 1 phase caps will have LN voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_correct_PTratios</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="c1"># Get original cap bank control settings</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">()</span>
                    <span class="n">cap_type</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cap_name</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">cap_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;volt&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">ONSetting</span><span class="p">(),</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">OFFSetting</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Capacitor.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">cap_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">cap_bus</span><span class="p">)</span>
            <span class="n">cap_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">())</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Capacitor.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">PT_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap_kv</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_correct_PTratios</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_ratio</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.correct_cap_bank_settings"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.correct_cap_bank_settings">[docs]</a>    <span class="k">def</span> <span class="nf">correct_cap_bank_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Add a function to sweep through possible capacitor bank settings</span>
        <span class="n">caps_with_control</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cap_on_settings_check</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Correct settings of those cap banks for which cap control object is available</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">()</span>
                <span class="n">caps_with_control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cap_name</span><span class="p">)</span>
                <span class="n">orig_sett</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;voltage&quot;</span><span class="p">:</span>
                    <span class="n">orig_sett</span> <span class="o">=</span> <span class="s2">&quot; !original&quot;</span>
                <span class="n">control_command</span> <span class="o">=</span> <span class="s2">&quot;Edit CapControl.</span><span class="si">{cc}</span><span class="s2"> PTRatio=</span><span class="si">{pt}</span><span class="s2"> Type=</span><span class="si">{tp}</span><span class="s2"> ONsetting=</span><span class="si">{o}</span><span class="s2"> OFFsetting=</span><span class="si">{of}</span><span class="s2">&quot;</span> \
                                  <span class="s2">&quot; PTphase=</span><span class="si">{ph}</span><span class="s2"> Delay=</span><span class="si">{d}</span><span class="s2"> DelayOFF=</span><span class="si">{dof}</span><span class="s2"> DeadTime=</span><span class="si">{dt}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cc</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_correct_PTratios</span><span class="p">[</span><span class="n">cap_name</span><span class="p">],</span>
                    <span class="n">tp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_control</span><span class="p">,</span>
                    <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capON</span><span class="p">,</span>
                    <span class="n">of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span><span class="p">,</span>
                    <span class="n">ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PTphase</span><span class="p">,</span>
                    <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capONdelay</span><span class="p">,</span>
                    <span class="n">dof</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capOFFdelay</span><span class="p">,</span>
                    <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capdeadtime</span>
                <span class="p">)</span>
                <span class="n">control_command</span> <span class="o">=</span> <span class="n">control_command</span> <span class="o">+</span> <span class="n">orig_sett</span>
                <span class="n">cap_on_settings_check</span><span class="p">[</span><span class="n">cap_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capON</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>

                <span class="n">pass_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># If pass_flag returned false, means it had convergence error</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>
                    <span class="c1"># change command</span>
                    <span class="n">new_control_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">new_control_command</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                            <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">control_command</span> <span class="o">=</span> <span class="n">new_control_command</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="c1"># if there are caps without cap control add a cap control</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">caps_with_control</span><span class="p">):</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cap_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">caps_with_control</span><span class="p">:</span>
                    <span class="n">cap_ctrl_name</span> <span class="o">=</span> <span class="s2">&quot;capctrl&quot;</span> <span class="o">+</span> <span class="n">cap_name</span>
                    <span class="n">cap_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Get line to be controlled</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">Line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                        <span class="n">bus1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">bus1</span> <span class="o">==</span> <span class="n">cap_bus</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="n">control_command</span> <span class="o">=</span> <span class="s2">&quot;New CapControl.</span><span class="si">{cc}</span><span class="s2"> element=Line.</span><span class="si">{el}</span><span class="s2"> terminal=</span><span class="si">{trm}</span><span class="s2"> capacitor=</span><span class="si">{cbank}</span><span class="s2"> PTRatio=</span><span class="si">{pt}</span><span class="s2"> Type=</span><span class="si">{tp}</span><span class="s2">&quot;</span> \
                                      <span class="s2">&quot; ONsetting=</span><span class="si">{o}</span><span class="s2"> OFFsetting=</span><span class="si">{of}</span><span class="s2"> PTphase=</span><span class="si">{ph}</span><span class="s2"> Delay=</span><span class="si">{d}</span><span class="s2"> DelayOFF=</span><span class="si">{dof}</span><span class="s2"> DeadTime=</span><span class="si">{dt}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">cc</span><span class="o">=</span><span class="n">cap_ctrl_name</span><span class="p">,</span>
                        <span class="n">el</span><span class="o">=</span><span class="n">Line_name</span><span class="p">,</span>
                        <span class="n">trm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal</span><span class="p">,</span>
                        <span class="n">cbank</span><span class="o">=</span><span class="n">cap_name</span><span class="p">,</span>
                        <span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_correct_PTratios</span><span class="p">[</span><span class="n">cap_name</span><span class="p">],</span>
                        <span class="n">tp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_control</span><span class="p">,</span>
                        <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capON</span><span class="p">,</span>
                        <span class="n">of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span><span class="p">,</span>
                        <span class="n">ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PTphase</span><span class="p">,</span>
                        <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capONdelay</span><span class="p">,</span>
                        <span class="n">dof</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capOFFdelay</span><span class="p">,</span>
                        <span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capdeadtime</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cap_ctrl_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="p">[</span><span class="n">cap_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">capON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="n">cap_on_settings_check</span><span class="p">[</span><span class="n">cap_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capON</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>

                    <span class="n">pass_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                        <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># If pass_flag returned false, means it had convergence error</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_flag</span><span class="p">:</span>
                        <span class="c1"># change command</span>
                        <span class="n">new_control_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">new_control_command</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">control_command</span> <span class="o">=</span> <span class="n">new_control_command</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Capacitor.&quot;</span> <span class="o">+</span> <span class="n">cap_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Capacitors</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>

        <span class="c1"># Check whether settings have been applied or not</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cap_on</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">ONSetting</span><span class="p">()</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cap_on</span> <span class="o">-</span> <span class="n">cap_on_settings_check</span><span class="p">[</span><span class="n">cap_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Settings for cap bank </span><span class="si">%s</span><span class="s2"> not implemented&quot;</span><span class="p">,</span> <span class="n">cap_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># self.get_nodal_violations()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_viols_with_initial_cap_settings"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_viols_with_initial_cap_settings">[docs]</a>    <span class="k">def</span> <span class="nf">get_viols_with_initial_cap_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cap_name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">ONSetting</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">OFFSetting</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_sweep_res_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.cap_settings_sweep"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.cap_settings_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">cap_settings_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">):</span>
        <span class="c1"># This function increases differences between cap ON and OFF voltages in user defined increments,</span>
        <span class="c1">#  default 1 volt, until upper and lower bounds are reached.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_sweep_res_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_viols_with_initial_cap_settings</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">&gt;</span> <span class="n">lower_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
            <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">&lt;</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
            <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
            <span class="c1"># Apply cap ON and OFF settings and determine their impact</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span><span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cc_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;Edit CapControl.</span><span class="si">{cc}</span><span class="s2"> ONsetting=</span><span class="si">{o}</span><span class="s2"> OFFsetting=</span><span class="si">{of}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cc</span><span class="o">=</span><span class="n">cc_name</span><span class="p">,</span>
                    <span class="n">o</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span><span class="p">,</span>
                    <span class="n">of</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span>
                <span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_sweep_res_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">lower_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
                <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">=</span> <span class="n">lower_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_on_setting</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span>
                <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_off_setting</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_control_gap</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_best_capsetting</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_orig_cap_setting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_orig_cap_setting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_orig_cap_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_initial_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cap_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Capacitor</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cap_name</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit CapControl.</span><span class="si">{ccn}</span><span class="s2"> ONsetting=</span><span class="si">{o}</span><span class="s2"> OFFsetting=</span><span class="si">{of}</span><span class="s2"> !original&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">ccn</span><span class="o">=</span><span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span>
                        <span class="n">o</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">of</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_best_capsetting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_best_capsetting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_best_capsetting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">):</span>
        <span class="n">best_setting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Start with assumption that each node has a violation at all time points and each violation if outside bounds</span>
        <span class="c1">#  by upper voltage limit - basically the maximum possible severity</span>
        <span class="n">min_severity</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">upper_limit</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap_sweep_res_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">min_severity</span><span class="p">:</span>
                <span class="n">min_severity</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">best_setting</span> <span class="o">=</span> <span class="n">key</span>
        <span class="c1"># Apply best settings which give minimum severity index</span>
        <span class="k">if</span> <span class="n">best_setting</span> <span class="o">==</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_orig_cap_setting</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_on_setting</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">best_off_setting</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cc_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Edit CapControl.</span><span class="si">{cc}</span><span class="s2"> ONsetting=</span><span class="si">{o}</span><span class="s2"> OFFsetting=</span><span class="si">{of}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cc</span><span class="o">=</span><span class="n">cc_name</span><span class="p">,</span>
                    <span class="n">o</span><span class="o">=</span><span class="n">best_on_setting</span><span class="p">,</span>
                    <span class="n">of</span><span class="o">=</span><span class="n">best_off_setting</span>
                <span class="p">))</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">CapControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.edit_capacitor_settings_for_convergence"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.edit_capacitor_settings_for_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">edit_capacitor_settings_for_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_command</span><span class="p">):</span>
        <span class="n">new_deadtime</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">new_delay</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capON</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;cap_sweep_voltage_gap&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changed Initial On and Off Cap settings to avoid convergence issues &quot;</span><span class="p">)</span>

        <span class="n">new_capON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capON</span>
        <span class="n">new_capOFF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capOFF</span>

        <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">control_command</span>
        <span class="c1"># self.remove_line_from_dss_file(control_command)  # remove command that caused convergence issue</span>
        <span class="n">control_command</span> <span class="o">=</span> <span class="n">control_command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">)</span>
        <span class="n">control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;enabled=True&quot;</span><span class="p">,</span> <span class="s2">&quot;enabled=False&quot;</span><span class="p">,</span> <span class="n">control_command</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>  <span class="c1"># disable and run previous control command</span>

        <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;DeadTime=\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;DeadTime=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_deadtime</span><span class="p">),</span> <span class="n">new_control_command</span><span class="p">)</span>
        <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;Delay=\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;Delay=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_delay</span><span class="p">),</span> <span class="n">new_control_command</span><span class="p">)</span>
        <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;ONsetting=\d+\.\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;ONsetting=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_capON</span><span class="p">),</span> <span class="n">new_control_command</span><span class="p">)</span>
        <span class="n">new_control_command</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;OFFsetting=\d+\.\d+&quot;</span><span class="p">,</span> <span class="s1">&#39;OFFsetting=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_capOFF</span><span class="p">),</span> <span class="n">new_control_command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_control_command</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.write_dss_file"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.write_dss_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_dss_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device_command</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.write_upgrades_to_file"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.write_upgrades_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_upgrades_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;voltage_upgrades.dss&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span><span class="p">:</span>
                <span class="n">datafile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.reg_controls_sweep"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.reg_controls_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">reg_controls_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">lower_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reg_v_delta&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">reg_sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bandw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reg_control_bands&quot;</span><span class="p">]:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">regctrl_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                    <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                    <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Skipping over substation LTC if it exists</span>
                    <span class="c1"># for n, d in self.G.in_degree().items():</span>
                    <span class="c1">#     if d == 0:</span>
                    <span class="c1">#         sourcebus = n</span>
                    <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                    <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regctrl_name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regctrl_name</span><span class="p">))</span>

                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Regcontrol.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rn</span><span class="o">=</span><span class="n">regctrl_name</span><span class="p">,</span>
                        <span class="n">sp</span><span class="o">=</span><span class="n">reg_sp</span><span class="p">,</span>
                        <span class="n">b</span><span class="o">=</span><span class="n">bandw</span>
                    <span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reg_sweep_viols</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">reg_sp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">bandw</span><span class="p">))]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_best_regsetting</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_best_regsetting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_best_regsetting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_best_regsetting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">):</span>
        <span class="c1"># TODO: Remove substation LTC from the settings sweep</span>
        <span class="n">best_setting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Start with assumption that each node has a violation at all time points and each violation if outside bounds</span>
        <span class="c1">#  by upper voltage limit - basically the maximum possible severity</span>
        <span class="n">min_severity</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">upper_limit</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_sweep_viols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">min_severity</span><span class="p">:</span>
                <span class="n">min_severity</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">best_setting</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">best_setting</span> <span class="o">==</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_orig_reg_setting</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_band</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">reg_ctrl_nm</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl_nm</span><span class="p">))</span>
                <span class="c1"># Skipping over substation LTC if it exists</span>
                <span class="c1"># for n, d in self.G.in_degree().items():</span>
                <span class="c1">#     if d == 0:</span>
                <span class="c1">#         sourcebus = n</span>
                <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl_nm</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">continue</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">rn</span><span class="o">=</span><span class="n">reg_ctrl_nm</span><span class="p">,</span>
                    <span class="n">sp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span><span class="p">,</span>
                    <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_band</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_orig_reg_setting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_orig_reg_setting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_orig_reg_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_regctrls_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_band</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;RegControl.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> !original&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rn</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">b</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.add_substation_LTC"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.add_substation_LTC">[docs]</a>    <span class="k">def</span> <span class="nf">add_substation_LTC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This function identifies whether or not a substation LTC exists - if not adds one along with a new sub xfmr</span>
        <span class="c1"># if required -  if one exists corrects its settings</span>
        <span class="c1"># Identify source bus</span>
        <span class="c1"># It seems that networkx in a directed graph only counts edges incident on a node towards degree.</span>
        <span class="c1">#  This is why source bus is the only bus which has a degree of zero</span>
        <span class="c1"># for n, d in self.G.in_degree().items():</span>
        <span class="c1">#     if d == 0:</span>
        <span class="c1">#         self.source = n</span>

        <span class="c1"># Identify whether a transformer is connected to this bus or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
            <span class="n">from_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">to_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">from_bus</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">or</span> <span class="n">to_bus</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_bus</span> <span class="o">=</span> <span class="n">to_bus</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># Add new transformer if no transformer is connected to source bus, then add LTC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_xfmr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_regctrl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">subxfmr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># add LTC onto existing substation transformer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_regctrl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_LTC_bus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.add_new_xfmr"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.add_new_xfmr">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_xfmr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># If substation does not have a transformer add a transformer at the source bus so a new reg</span>
        <span class="c1"># control object may be created -  after the transformer and reg control have been added the feeder would have</span>
        <span class="c1">#  to be re compiled as system admittance matrix has changed</span>
        <span class="c1"># Find line to which this node is connected to</span>
        <span class="c1"># node = node.lower()</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># For sub LTC</span>
            <span class="k">if</span> <span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">bus1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span>
                    <span class="n">bus2</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span>
                    <span class="n">new_node</span> <span class="o">=</span> <span class="s2">&quot;Regctrl_&quot;</span> <span class="o">+</span> <span class="n">bus2</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="s2">&quot;New_xfmr_&quot;</span> <span class="o">+</span> <span class="n">node</span>
                    <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
                    <span class="n">amps</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus1</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus2</span><span class="p">)</span>
                    <span class="n">kV_node</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span> <span class="o">*</span> <span class="mf">1.732</span>
                        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_DT</span> <span class="o">*</span> <span class="n">amps</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% over sized transformer - ideally we</span>
                        <span class="c1"># would use an auto transformer which would need a much smaller kVA rating</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Transformer.</span><span class="si">{xfn}</span><span class="s2"> phases=</span><span class="si">{p}</span><span class="s2"> windings=2 buses=(</span><span class="si">{b1}</span><span class="s2">,</span><span class="si">{b2}</span><span class="s2">) conns=(</span><span class="si">{cntp}</span><span class="s2">,</span><span class="si">{cntp}</span><span class="s2">)&quot;</span> \
                                         <span class="s2">&quot; kvs=(</span><span class="si">{kv}</span><span class="s2">,</span><span class="si">{kv}</span><span class="s2">) kvas=(</span><span class="si">{kva}</span><span class="s2">,</span><span class="si">{kva}</span><span class="s2">) xhl=0.001 wdg=1 </span><span class="si">%r</span><span class="s2">=0.001 wdg=2 </span><span class="si">%r</span><span class="s2">=0.001&quot;</span> \
                                         <span class="s2">&quot; Maxtap=1.1 Mintap=0.9 enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">xfn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                            <span class="n">p</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                            <span class="n">b1</span><span class="o">=</span><span class="n">bus1</span><span class="p">,</span>
                            <span class="n">b2</span><span class="o">=</span><span class="n">new_node</span><span class="p">,</span>
                            <span class="n">cntp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_conn</span><span class="p">,</span>
                            <span class="n">kv</span><span class="o">=</span><span class="n">kV_DT</span><span class="p">,</span>
                            <span class="n">kva</span><span class="o">=</span><span class="n">kVA</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">phases</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_node</span> <span class="o">*</span> <span class="n">amps</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% over sized transformer - ideally we</span>
                        <span class="c1"># would use an auto transformer which would need a much smaller kVA rating</span>
                        <span class="c1"># make bus1 of line as reg ctrl node</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Transformer.</span><span class="si">{xfn}</span><span class="s2"> phases=</span><span class="si">{p}</span><span class="s2"> windings=2 buses=(</span><span class="si">{b1}</span><span class="s2">,</span><span class="si">{b2}</span><span class="s2">) conns=(</span><span class="si">{cntp}</span><span class="s2">,</span><span class="si">{cntp}</span><span class="s2">)&quot;</span> \
                                         <span class="s2">&quot; kvs=(</span><span class="si">{kv}</span><span class="s2">,</span><span class="si">{kv}</span><span class="s2">) kvas=(</span><span class="si">{kva}</span><span class="s2">,</span><span class="si">{kva}</span><span class="s2">) xhl=0.001 wdg=1 </span><span class="si">%r</span><span class="s2">=0.001 wdg=2 </span><span class="si">%r</span><span class="s2">=0.001&quot;</span> \
                                         <span class="s2">&quot; Maxtap=1.1 Mintap=0.9 enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">xfn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                            <span class="n">p</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                            <span class="n">b1</span><span class="o">=</span><span class="n">bus1</span><span class="p">,</span>
                            <span class="n">b2</span><span class="o">=</span><span class="n">new_node</span><span class="p">,</span>
                            <span class="n">cntp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_conn</span><span class="p">,</span>
                            <span class="n">kv</span><span class="o">=</span><span class="n">kV_node</span><span class="p">,</span>
                            <span class="n">kva</span><span class="o">=</span><span class="n">kVA</span>
                        <span class="p">)</span>
                    <span class="n">control_command</span> <span class="o">=</span> <span class="s2">&quot;Edit Line.</span><span class="si">{}</span><span class="s2"> bus1=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="c1"># Update system admittance matrix</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="s2">&quot;//</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_nx_representation</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.&quot;</span> <span class="o">+</span> <span class="n">line_name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># For regulator</span>
            <span class="k">elif</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">bus1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span>
                    <span class="n">bus2</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span>
                    <span class="n">new_node</span> <span class="o">=</span> <span class="s2">&quot;Regctrl_&quot;</span> <span class="o">+</span> <span class="n">bus2</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="s2">&quot;New_xfmr_&quot;</span> <span class="o">+</span> <span class="n">node</span>
                    <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
                    <span class="n">amps</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">bus2</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">()</span>
                    <span class="n">kV_node</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">kV_DT</span> <span class="o">=</span> <span class="n">kV_node</span> <span class="o">*</span> <span class="mf">1.732</span>
                        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_DT</span> <span class="o">*</span> <span class="n">amps</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% over sized transformer - ideally we</span>
                        <span class="c1"># would use an auto transformer which would need a much smaller kVA rating</span>

                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Transformer.</span><span class="si">{xfn}</span><span class="s2"> phases=</span><span class="si">{p}</span><span class="s2"> windings=2 buses=(</span><span class="si">{b1}</span><span class="s2">,</span><span class="si">{b2}</span><span class="s2">) conns=(wye,wye)&quot;</span> \
                                         <span class="s2">&quot; kvs=(</span><span class="si">{kv}</span><span class="s2">,</span><span class="si">{kv}</span><span class="s2">) kvas=(</span><span class="si">{kva}</span><span class="s2">,</span><span class="si">{kva}</span><span class="s2">) xhl=0.001 wdg=1 </span><span class="si">%r</span><span class="s2">=0.001 wdg=2 </span><span class="si">%r</span><span class="s2">=0.001&quot;</span> \
                                         <span class="s2">&quot; Maxtap=1.1 Mintap=0.9 enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">xfn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                            <span class="n">p</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                            <span class="n">b1</span><span class="o">=</span><span class="n">new_node</span><span class="p">,</span>
                            <span class="n">b2</span><span class="o">=</span><span class="n">bus2</span><span class="p">,</span>
                            <span class="n">kv</span><span class="o">=</span><span class="n">kV_DT</span><span class="p">,</span>
                            <span class="n">kva</span><span class="o">=</span><span class="n">kVA</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">phases</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">kVA</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kV_node</span> <span class="o">*</span> <span class="n">amps</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% over sized transformer - ideally we</span>
                        <span class="c1"># would use an auto transformer which would need a much smaller kVA rating</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Transformer.</span><span class="si">{xfn}</span><span class="s2"> phases=</span><span class="si">{p}</span><span class="s2"> windings=2 buses=(</span><span class="si">{b1}</span><span class="s2">,</span><span class="si">{b2}</span><span class="s2">) conns=(wye,wye)&quot;</span> \
                                         <span class="s2">&quot; kvs=(</span><span class="si">{kv}</span><span class="s2">,</span><span class="si">{kv}</span><span class="s2">) kvas=(</span><span class="si">{kva}</span><span class="s2">,</span><span class="si">{kva}</span><span class="s2">) xhl=0.001 wdg=1 </span><span class="si">%r</span><span class="s2">=0.001 wdg=2 </span><span class="si">%r</span><span class="s2">=0.001&quot;</span> \
                                         <span class="s2">&quot; Maxtap=1.1 Mintap=0.9 enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">xfn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                            <span class="n">p</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                            <span class="n">b1</span><span class="o">=</span><span class="n">new_node</span><span class="p">,</span>
                            <span class="n">b2</span><span class="o">=</span><span class="n">bus2</span><span class="p">,</span>
                            <span class="n">kv</span><span class="o">=</span><span class="n">kV_node</span><span class="p">,</span>
                            <span class="n">kva</span><span class="o">=</span><span class="n">kVA</span>
                        <span class="p">)</span>
                    <span class="n">control_command</span> <span class="o">=</span> <span class="s2">&quot;Edit Line.</span><span class="si">{}</span><span class="s2"> bus2=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">control_command</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="c1"># Update system admittance matrix</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="s2">&quot;//</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">generate_nx_representation</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.&quot;</span> <span class="o">+</span> <span class="n">line_name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.add_new_regctrl"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.add_new_regctrl">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_regctrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Identify whether or not a reg contrl exists at the transformer connected to this bus - a transformer should</span>
        <span class="c1"># definitely exist by now. If it does correct its settings else add a new reg ctrl with correct settings</span>
        <span class="c1"># If transformer exists check if it already has a reg control object</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Identify transformer connected to this node</span>
                <span class="n">bus_prim</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">bus_sec</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bus_prim</span> <span class="o">==</span> <span class="n">node</span> <span class="ow">or</span> <span class="n">bus_sec</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="c1"># node info is only used to get correct kv values</span>
                    <span class="n">kV</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                    <span class="n">winding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_wdg</span>
                    <span class="n">vreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_setpoint</span>
                    <span class="n">reg_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_delay</span>
                    <span class="n">deadband</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LTC_band</span>
                    <span class="n">pt_ratio</span> <span class="o">=</span> <span class="n">kV</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">])</span>

                    <span class="n">xfmr_regctrl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="c1"># Identify whether a reg control exists on this transformer</span>
                    <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">xfmr_name_reg</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">xfmr_name_reg</span> <span class="o">==</span> <span class="n">xfmr_name</span><span class="p">:</span>
                                <span class="c1"># if reg control already exists correct its settings</span>
                                <span class="n">xfmr_regctrl</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> transformer=</span><span class="si">{tn}</span><span class="s2"> winding=</span><span class="si">{w}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> ptratio=</span><span class="si">{rt}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> &quot;</span> \
                                                 <span class="s2">&quot;enabled=true delay=</span><span class="si">{d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">rn</span><span class="o">=</span><span class="n">xfmr_regctrl</span><span class="p">,</span>
                                    <span class="n">tn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                                    <span class="n">w</span><span class="o">=</span><span class="n">winding</span><span class="p">,</span>
                                    <span class="n">sp</span><span class="o">=</span><span class="n">vreg</span><span class="p">,</span>
                                    <span class="n">rt</span><span class="o">=</span><span class="n">pt_ratio</span><span class="p">,</span>
                                    <span class="n">b</span><span class="o">=</span><span class="n">deadband</span><span class="p">,</span>
                                    <span class="n">d</span><span class="o">=</span><span class="n">reg_delay</span>
                                <span class="p">)</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;Calcvoltagebases&quot;</span><span class="p">)</span>
                                <span class="c1"># add this to a dss_upgrades.dss file</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="c1"># check for violations</span>
                                <span class="c1"># self.get_nodal_violations()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">xfmr_regctrl</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="c1"># if reg control does not exist on the transformer add one</span>
                        <span class="n">xfmr_regctrl</span> <span class="o">=</span> <span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">node</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New RegControl.</span><span class="si">{rn}</span><span class="s2"> transformer=</span><span class="si">{tn}</span><span class="s2"> winding=</span><span class="si">{w}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> ptratio=</span><span class="si">{rt}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> &quot;</span> \
                                         <span class="s2">&quot;enabled=true delay=</span><span class="si">{d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">rn</span><span class="o">=</span><span class="n">xfmr_regctrl</span><span class="p">,</span>
                            <span class="n">tn</span><span class="o">=</span><span class="n">xfmr_name</span><span class="p">,</span>
                            <span class="n">w</span><span class="o">=</span><span class="n">winding</span><span class="p">,</span>
                            <span class="n">sp</span><span class="o">=</span><span class="n">vreg</span><span class="p">,</span>
                            <span class="n">rt</span><span class="o">=</span><span class="n">pt_ratio</span><span class="p">,</span>
                            <span class="n">b</span><span class="o">=</span><span class="n">deadband</span><span class="p">,</span>
                            <span class="n">d</span><span class="o">=</span><span class="n">reg_delay</span>
                        <span class="p">)</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
                        <span class="c1"># add this to a dss_upgrades.dss file</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="c1"># check for violations</span>
                        <span class="c1"># self.get_nodal_violations()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.&quot;</span> <span class="o">+</span> <span class="n">xfmr_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.LTC_controls_sweep"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.LTC_controls_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">LTC_controls_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">lower_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">upper_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_voltage&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reg_v_delta&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">reg_sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bandw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;reg_control_bands&quot;</span><span class="p">]:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">regctrl_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                    <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                    <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Skipping over substation LTC if it exists</span>
                    <span class="c1"># for n, d in self.G.in_degree().items():</span>
                    <span class="c1">#     if d == 0:</span>
                    <span class="c1">#         sourcebus = n</span>
                    <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                    <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regctrl_name</span><span class="p">))</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Regcontrol.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">rn</span><span class="o">=</span><span class="n">regctrl_name</span><span class="p">,</span>
                            <span class="n">sp</span><span class="o">=</span><span class="n">reg_sp</span><span class="p">,</span>
                            <span class="n">b</span><span class="o">=</span><span class="n">bandw</span>
                        <span class="p">)</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="n">pass_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                            <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                            <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regctrl_name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subLTC_sweep_viols</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">reg_sp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">bandw</span><span class="p">))]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_best_LTCsetting</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_best_LTCsetting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_best_LTCsetting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_best_LTCsetting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">):</span>
        <span class="c1"># TODO: Remove substation LTC from the settings sweep</span>
        <span class="n">best_setting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Start with assumption that each node has a violation at all time points and each violation if outside bounds</span>
        <span class="c1">#  by upper voltage limit - basically the maximum possible severity</span>
        <span class="n">min_severity</span> <span class="o">=</span> <span class="mi">10000000000000</span>
        <span class="c1"># TODO - below logic for min_severity was used previously - however, error cases were encountered</span>
        <span class="c1">#  for some feeders due to min_severity being not large enough</span>
        <span class="c1"># min_severity = pow(len(self.all_bus_names), 2) * len(self.config[&quot;tps_to_test&quot;]) * upper_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Severity: </span><span class="si">{</span><span class="nb">pow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tps_to_test&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">upper_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subLTC_sweep_viols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subLTC_sweep_viols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">min_severity</span><span class="p">:</span>
                <span class="n">min_severity</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">best_setting</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">best_setting</span> <span class="o">==</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_orig_LTC_setting</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Best_setting: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">best_setting</span><span class="p">)</span>
            <span class="n">v_sp</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reg_band</span> <span class="o">=</span> <span class="n">best_setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">reg_ctrl_nm</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">xfmr</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Transformer</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Transformer.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="p">))</span>
                <span class="n">xfmr_buses</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                <span class="n">xfmr_b1</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xfmr_b2</span> <span class="o">=</span> <span class="n">xfmr_buses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># # Skipping over substation LTC if it exists</span>
                <span class="c1"># for n, d in self.G.in_degree().items():</span>
                <span class="c1">#     if d == 0:</span>
                <span class="c1">#         sourcebus = n</span>
                <span class="n">sourcebus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                <span class="k">if</span> <span class="n">xfmr_b1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">xfmr_b2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">sourcebus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl_nm</span><span class="p">))</span>

                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rn</span><span class="o">=</span><span class="n">reg_ctrl_nm</span><span class="p">,</span>
                        <span class="n">sp</span><span class="o">=</span><span class="n">v_sp</span><span class="p">,</span>
                        <span class="n">b</span><span class="o">=</span><span class="n">reg_band</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="n">pass_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pass_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                                        <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">,</span>
                                                                        <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># TODO : add code to change settings if there is a convergence error</span>
                    <span class="k">if</span> <span class="n">pass_flag</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">apply_orig_LTC_setting</span><span class="p">()</span>

                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Regcontrol.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_ctrl_nm</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">RegControls</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.apply_orig_LTC_setting"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.apply_orig_LTC_setting">[docs]</a>    <span class="k">def</span> <span class="nf">apply_orig_LTC_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_subLTC_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;RegControl.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> vreg=</span><span class="si">{sp}</span><span class="s2"> band=</span><span class="si">{b}</span><span class="s2"> !original&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rn</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                <span class="n">sp</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">b</span><span class="o">=</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_shortest_path"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_shortest_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
        <span class="n">precal_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Get upper triangular distance matrix - reduces computational time by half</span>
        <span class="k">for</span> <span class="n">bus1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span><span class="p">[</span><span class="n">bus1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bus_n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bus_n</span> <span class="o">==</span> <span class="n">bus1</span><span class="p">:</span>
                    <span class="n">path_length</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">elif</span> <span class="n">bus_n</span> <span class="ow">in</span> <span class="n">precal_paths</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">new_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">bus1</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">bus_n</span><span class="p">)</span>
                    <span class="n">path_length</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">nodes_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">path_length</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_graph</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="n">nodes_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">path</span><span class="p">[</span><span class="n">nodes_count</span><span class="p">]][</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span><span class="p">[</span><span class="n">bus1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">path_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">precal_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bus1</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.get_full_distance_dict"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.get_full_distance_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_distance_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">square_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">square_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                <span class="n">max_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># Create a square dict with zeros for lower triangle values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">temp_nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
                <span class="n">new_items_req</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">items_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_items_req</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">square_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_list</span>
        <span class="c1"># Replace lower triangle zeros with upper triangle values</span>
        <span class="n">key_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">UT_paths_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">items_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">square_dict</span><span class="p">[</span><span class="n">temp_nodes_list</span><span class="p">[</span><span class="n">items_count</span><span class="p">]][</span><span class="n">key_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">items_count</span><span class="p">]</span>
            <span class="n">key_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">temp_nodes_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># from dict create a list of lists</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># Create numpy array from list of lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">square_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.plot_heatmap_distmatrix"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.plot_heatmap_distmatrix">[docs]</a>    <span class="k">def</span> <span class="nf">plot_heatmap_distmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">square_array</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distance matrix of nodes with violations&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span><span class="s2">&quot;Nodal_violations_heatmap.pdf&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.cluster_square_array"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.cluster_square_array">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_square_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clustering the distance matrix into clusters equal to optimal clusters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_heatmap_distmatrix</span><span class="p">()</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_reg_flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">square_array</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_</span>
            <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">lab</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_nodes_list</span><span class="p">[</span><span class="n">lab</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">lab</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_nodes_list</span><span class="p">[</span><span class="n">lab</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identify_correct_reg_node</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_reg_common_nodes</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_reg_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_controls_sweep</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                                     <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_band</span><span class="p">],</span> <span class="p">[]]</span>
            <span class="c1"># Store all optimal nodes for a given number of clusters</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_topology_plots&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_created_clusters</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;max_V_viol=</span><span class="si">%s</span><span class="s2">, min_V_viol=</span><span class="si">%s</span><span class="s2">, severity_indices=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable_regctrl_current_cluster</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All nodal violations have been removed successfully.....quitting&quot;</span><span class="p">)</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.disable_regctrl_current_cluster"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.disable_regctrl_current_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">disable_regctrl_current_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">disable_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span>
        <span class="k">if</span> <span class="n">disable_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_optimal_reg_nodes</span><span class="p">[</span><span class="n">disable_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disable_added_xfmr</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> enabled=False&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">rn</span><span class="o">=</span><span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">node</span>
                <span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="c1"># self.write_dss_file(command_string)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.disable_added_xfmr"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.disable_added_xfmr">[docs]</a>    <span class="k">def</span> <span class="nf">disable_added_xfmr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Unfortunately since OpenDSS disables by transformer by opening the circuit instead of creating a short circuit,</span>
        <span class="c1"># this function will remove the transformer by first disabling it, then it will connect the line properly to</span>
        <span class="c1"># remove the islands</span>
        <span class="c1"># Substation will always have a xfmr by this point so only regulator transformers have to be removed</span>

        <span class="n">transformer_name</span> <span class="o">=</span> <span class="s2">&quot;New_xfmr_&quot;</span> <span class="o">+</span> <span class="n">node</span>

        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">transformer_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">prim_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sec_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Transformer.</span><span class="si">{xfmr}</span><span class="s2"> enabled=False&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xfmr</span><span class="o">=</span><span class="n">transformer_name</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Transformer.</span><span class="si">{xfmr}</span><span class="s2"> buses=(</span><span class="si">{b1}</span><span class="s2">,</span><span class="si">{b2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">xfmr</span><span class="o">=</span><span class="n">transformer_name</span><span class="p">,</span>
                    <span class="n">b1</span><span class="o">=</span><span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">b2</span><span class="o">=</span><span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">prim_bus</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Line.</span><span class="si">{ln}</span><span class="s2"> bus2=</span><span class="si">{b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ln</span><span class="o">=</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span>
                            <span class="n">b</span><span class="o">=</span><span class="n">sec_bus</span>
                        <span class="p">)</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="c1"># Update system admittance matrix</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;CalcVoltageBases&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">generate_nx_representation</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.add_new_reg_common_nodes"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.add_new_reg_common_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_reg_common_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">):</span>
        <span class="c1"># Identify whether a transformer exists at this node or not. If yes simply add a new reg control -</span>
        <span class="c1"># in fact calling the add_new_regctrl function will automatically check whether a reg control exists or not</span>
        <span class="c1"># -  so only thing to be ensured is that a transformer should exist - for next time when this function is called</span>
        <span class="c1">#  a new set of clusters will be passed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">common_nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_nodes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vdev_cluster_nodes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">common_nodes</span><span class="p">:</span>
                <span class="n">continue_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Here do not add a new reg control to source bus as it already has a LTC</span>
                <span class="c1"># for n, d in self.G.in_degree().items():</span>
                <span class="c1">#     if n == node and d==0:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">continue_flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">continue_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="n">xfmr_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                    <span class="c1"># dss.Circuit.SetActiveElement(&quot;Transformer.&quot;+xfmr_name)</span>
                    <span class="n">prim_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sec_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">sec_bus</span> <span class="ow">or</span> <span class="n">node</span> <span class="o">==</span> <span class="n">prim_bus</span><span class="p">:</span>
                        <span class="n">xfmr_flag</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">xfmr_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_new_xfmr</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="c1"># These are just trial settings and do not have to be written in the output file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_new_regctrl</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">xfmr_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># The reason is that we are skipping over LTC node already, and all other other nodes with</span>
                    <span class="c1"># pre-existing xfmrs will be primary to secondary DTs which we do not want to control as regs are</span>
                    <span class="c1"># primarily in line and not on individual distribution transformers</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdev_cluster_nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># self.get_nodes_withV(node)</span>
                <span class="c1"># Now disable the added regulator control and remove the added transformer</span>
                <span class="k">if</span> <span class="n">xfmr_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> enabled=No&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rn</span><span class="o">=</span><span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">node</span>
                    <span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disable_added_xfmr</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># For a given cluster identify the node which leads to minimum number of buses with violations</span>
            <span class="n">min_severity</span> <span class="o">=</span> <span class="mi">1000000000</span>
            <span class="c1"># TODO - below logic for min_severity was used previously - however, error cases were encountered</span>
            <span class="c1">#  for some feeders due to min_severity being not large enough</span>
            <span class="c1"># min_severity = pow(len(self.all_bus_names), 2) * len(self.config[&quot;tps_to_test&quot;]) * upper_limit</span>
            <span class="n">min_node</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdev_cluster_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">min_severity</span><span class="p">:</span>
                    <span class="n">min_severity</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">min_node</span> <span class="o">=</span> <span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Min node is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">min_node</span><span class="p">)</span>
            <span class="c1"># If no nodes is found break the loop and go to next number of clusters:</span>
            <span class="k">if</span> <span class="n">min_node</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_node</span>
            <span class="c1"># Since this is an optimal location add the transformer here - this transformer will stay as long as</span>
            <span class="c1"># self.optimal_clusters does not increment. If this parameter changes then all devices at nodes mentioned</span>
            <span class="c1"># in previous optimal cluster number in self.cluster_optimal_reg_nodes should be disabled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_new_xfmr</span><span class="p">(</span><span class="n">min_node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit RegControl.</span><span class="si">{rn}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rn</span><span class="o">=</span><span class="s2">&quot;New_regctrl_&quot;</span> <span class="o">+</span> <span class="n">min_node</span>
            <span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">,</span>
                                                    <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_limit</span><span class="p">)</span>
            <span class="c1"># Even here we do not need to write out the setting as the only setting to be written would</span>
            <span class="c1"># self.write_dss_file(command_string)</span>
        <span class="c1"># if no reg control nodes are found then continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_reg_flag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.identify_correct_reg_node"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.identify_correct_reg_node">[docs]</a>    <span class="k">def</span> <span class="nf">identify_correct_reg_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># In this function the very first common upstream node and all upstream nodes for all members of the</span>
        <span class="c1">#  cluster are stored</span>
        <span class="c1"># TODO: include some type of optimization - such as look at multiple upstream nodes and place where sum of</span>
        <span class="c1"># TODO: downstream node voltage deviations is minimum as long as it doesn&#39;t overlap with other clusters</span>
        <span class="c1"># Currently it only identifies the common upstream nodes for all cluster nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_nodes_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">temp_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">new_graph</span> <span class="o">=</span> <span class="n">temp_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">paths_dict_cluster</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">common_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">buses</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">new_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">buses</span><span class="p">)</span>
                <span class="n">paths_dict_cluster</span><span class="p">[</span><span class="n">buses</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">for</span> <span class="n">common_bus</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">bus</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">paths_dict_cluster</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">common_bus</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">common_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">common_bus</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upstream_nodes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_nodes</span>
            <span class="c1"># self.upstream_reg_node[key] = common_nodes[-1]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.plot_created_clusters"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.plot_created_clusters">[docs]</a>    <span class="k">def</span> <span class="nf">plot_created_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="c1"># Plots clusters and common paths from clusters to source</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="c1"># Show min V violations</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nodal_violations_pos</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">common_nodes_pos</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">reg_nodes_pos</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">cluster_nodes</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">nodal_violations_pos</span><span class="p">[</span><span class="n">cluster_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">cluster_nodes</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">common_nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_nodes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">common_nodes_pos</span><span class="p">[</span><span class="n">common_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">common_nodes</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">reg_nodes_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">nodal_violations_pos</span><span class="p">,</span>
                                       <span class="n">nodelist</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">common_nodes_pos</span><span class="p">,</span>
                                       <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream_nodes_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">reg_nodes_pos</span><span class="p">,</span>
                                       <span class="n">nodelist</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">upstream_reg_node</span><span class="p">[</span><span class="n">key</span><span class="p">]],</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;All buses with violations grouped in </span><span class="si">{}</span><span class="s2"> clusters&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;Cluster_</span><span class="si">{}</span><span class="s2">_reglocations.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimal_clusters</span><span class="p">))))</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.run"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">stepMax</span><span class="p">,</span> <span class="n">simulation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running voltage upgrade post process&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
            <span class="n">has_converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>

            <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">has_converged</span><span class="p">,</span> <span class="n">error</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AutomatedVoltageUpgrade.finalize"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedVoltageUpgrade.AutomatedVoltageUpgrade.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Aadil Latif.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>