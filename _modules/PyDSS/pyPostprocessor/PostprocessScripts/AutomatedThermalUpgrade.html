

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade &mdash; PyDSS 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> PyDSS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sample%20TOML%20files.html">Default simulation settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sample%20TOML%20files.html#default-visualization-settings">Default visualization settings</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#create-a-new-project">Create a new project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#exporting-data">Exporting Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#pre-filtering-export-data">Pre-filtering Export Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#run-a-project">Run a project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#analyze-results">Analyze results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#load-element-classes-and-properties">Load element classes and properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element">Read a dataframe for one element</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element-with-a-specific-option">Read a dataframe for one element with a specific option</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-one-element-with-an-option-matching-a-regular-expression">Read a dataframe for one element with an option matching a regular expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-the-total-value-for-a-property-stored-with-store-values-type-sum">Read the total value for a property stored with <code class="docutils literal notranslate"><span class="pre">store_values_type</span> <span class="pre">=</span> <span class="pre">&quot;sum&quot;</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#find-out-all-options-available-for-a-property">Find out all options available for a property</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#find-out-what-option-values-are-present-for-a-property">Find out what option values are present for a property</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#read-a-dataframe-for-all-elements">Read a dataframe for all elements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tutorial.html#performance-considerations">Performance Considerations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../tutorial.html#estimate-space-required-by-pydss-simulation">Estimate space required by PyDSS simulation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Project%20management.html">Improved project management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Result%20management.html">Enhanced result export features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Dynamic%20visualization%20capabilities.html">Dynamic visualization capabilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html">Frequency sweep plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#gis-plot">GIS plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#histogram-plot">Histogram plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#voltage-sag-plot">Voltage sag plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#time-series-plot">Time series plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#voltage-current-heatmap-plot">Voltage / Current heatmap plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Dynamic%20plots.html#xy-plots">XY plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Creating%20custom%20dynamic%20plots.html">Development of custom dynamic plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Extended%20controls%20library.html">Extended controls library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../Creating%20custom%20controls.html">Extending PyDSS controllers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../External%20interfaces%20for%20cosimulation.html">External PyDSS interfaces</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html">The socket interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html#the-helics-interface">The HELICS interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../interfaces.html#the-api-interface">The API interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Automated%20comparison%20of%20scenarios.html">Automated scenario comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reports.html">Reports</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#global-settings">Global settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../reports.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reports.html#granularity">Granularity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#export-parameters">Export Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#output-data">Output Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#adding-new-reports">Adding New Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reports.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hdf-data-format.html">HDF Data Format</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../hdf-data-format.html#layout">Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../hdf-data-format.html#common-metadata">Common Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../hdf-data-format.html#dataset-metadata">Dataset Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../hdf-data-format.html#attributes-per-dataset">Attributes per dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../hdf-data-format.html#metadata-datasets-per-dataset">Metadata datasets per dataset</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../hdf-data-format.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../PyDSS.html">PyDSS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../PyDSS/modules.html">PyDSS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html">PyDSS package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#subpackages">Subpackages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#submodules">Submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.NetworkModifier">PyDSS.NetworkModifier module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.ResultData">PyDSS.ResultData module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.SolveMode">PyDSS.SolveMode module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.common">PyDSS.common module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.config_data">PyDSS.config_data module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dataset_buffer">PyDSS.dataset_buffer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssBus">PyDSS.dssBus module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssCircuit">PyDSS.dssCircuit module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElement">PyDSS.dssElement module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElementFactory">PyDSS.dssElementFactory module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssInstance">PyDSS.dssInstance module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssObjectBase">PyDSS.dssObjectBase module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssTransformer">PyDSS.dssTransformer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_fields">PyDSS.element_fields module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_options">PyDSS.element_options module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.exceptions">PyDSS.exceptions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.export_list_reader">PyDSS.export_list_reader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.helics_interface">PyDSS.helics_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.loggers">PyDSS.loggers module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.metrics">PyDSS.metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.naerm">PyDSS.naerm module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.node_voltage_metrics">PyDSS.node_voltage_metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyContrReader">PyDSS.pyContrReader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyDSS">PyDSS.pyDSS module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyLogger">PyDSS.pyLogger module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyPlotReader">PyDSS.pyPlotReader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyResults">PyDSS.pyResults module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_fs_interface">PyDSS.pydss_fs_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_project">PyDSS.pydss_project module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_results">PyDSS.pydss_results module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.registry">PyDSS.registry module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.storage_filters">PyDSS.storage_filters module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.thermal_metrics">PyDSS.thermal_metrics module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.unitDefinations">PyDSS.unitDefinations module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.valiate_settings">PyDSS.valiate_settings module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.value_storage">PyDSS.value_storage module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../PyDSS/PyDSS.html">PyDSS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.Extensions.html">PyDSS.Extensions package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.ProfileManager.html">PyDSS.ProfileManager package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.api.html">PyDSS.api package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.cli.html">PyDSS.cli package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyControllers.html">PyDSS.pyControllers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyPlots.html">PyDSS.pyPlots package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.pyPostprocessor.html">PyDSS.pyPostprocessor package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../PyDSS/PyDSS.reports.html">PyDSS.reports package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.NetworkModifier">PyDSS.NetworkModifier module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.ResultData">PyDSS.ResultData module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.SolveMode">PyDSS.SolveMode module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.common">PyDSS.common module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.config_data">PyDSS.config_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dataset_buffer">PyDSS.dataset_buffer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssBus">PyDSS.dssBus module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssCircuit">PyDSS.dssCircuit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElement">PyDSS.dssElement module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssElementFactory">PyDSS.dssElementFactory module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssInstance">PyDSS.dssInstance module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssObjectBase">PyDSS.dssObjectBase module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.dssTransformer">PyDSS.dssTransformer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_fields">PyDSS.element_fields module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.element_options">PyDSS.element_options module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.exceptions">PyDSS.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.export_list_reader">PyDSS.export_list_reader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.helics_interface">PyDSS.helics_interface module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.loggers">PyDSS.loggers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.metrics">PyDSS.metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.naerm">PyDSS.naerm module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.node_voltage_metrics">PyDSS.node_voltage_metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyContrReader">PyDSS.pyContrReader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyDSS">PyDSS.pyDSS module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyLogger">PyDSS.pyLogger module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyPlotReader">PyDSS.pyPlotReader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pyResults">PyDSS.pyResults module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_fs_interface">PyDSS.pydss_fs_interface module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_project">PyDSS.pydss_project module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.pydss_results">PyDSS.pydss_results module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.registry">PyDSS.registry module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.storage_filters">PyDSS.storage_filters module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.thermal_metrics">PyDSS.thermal_metrics module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.unitDefinations">PyDSS.unitDefinations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.valiate_settings">PyDSS.valiate_settings module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS.value_storage">PyDSS.value_storage module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../PyDSS/PyDSS.html#module-PyDSS">Module contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">PyDSS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade</h1><div class="highlight"><pre>
<span></span><span class="c1">#**Authors:**</span>
<span class="c1"># Akshay Kumar Jain; Akshay.Jain@nrel.gov</span>

<span class="kn">from</span> <span class="nn">PyDSS.pyPostprocessor.pyPostprocessAbstract</span> <span class="kn">import</span> <span class="n">AbstractPostprocess</span>
<span class="kn">from</span> <span class="nn">PyDSS.exceptions</span> <span class="kn">import</span> <span class="n">InvalidParameter</span><span class="p">,</span> <span class="n">OpenDssConvergenceError</span>
<span class="c1"># Additional packages</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">opendssdirect</span> <span class="k">as</span> <span class="nn">dss</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="c1"># from place_new_regs import place_new_regs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="k">as</span> <span class="nn">ssd</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">PyDSS.pyPostprocessor.PostprocessScripts.postprocess_thermal_upgrades</span> <span class="kn">import</span> <span class="n">postprocess_thermal_upgrades</span>
<span class="kn">from</span> <span class="nn">PyDSS.utils.utils</span> <span class="kn">import</span> <span class="n">iter_elements</span><span class="p">,</span> <span class="n">check_redirect</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>

<span class="c1"># For an overloaded line if a sensible close enough line code is available then simply change the line code</span>
<span class="c1">#  else add a new line in parallel</span>
<span class="c1"># Does not correct switch thermal violations if any - will only work on line objects which are not marked as switches</span>
<span class="c1"># In this part of the code since lines and DTs</span>
<span class="c1"># The available upgrades options can be read from an external library as well, currently being created by reading</span>
<span class="c1">#  through the DTs and lines available in the feeder itself.</span>
<span class="c1"># TODO: Add xhl, xht, xlt and buses functionality for DTs</span>
<span class="c1"># TODO: Units of the line and transformers</span>
<span class="c1"># TODO: Correct line and xfmr violations safety margin issue</span>


<span class="c1"># to get xfmr information</span>
<div class="viewcode-block" id="get_transformer_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.get_transformer_info">[docs]</a><span class="k">def</span> <span class="nf">get_transformer_info</span><span class="p">():</span>
    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">xfmr_name</span><span class="p">,</span> <span class="s2">&quot;num_phases&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;Phases&quot;</span><span class="p">),</span>
                 <span class="s2">&quot;num_wdgs&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">NumWindings</span><span class="p">(),</span> <span class="s2">&quot;kva&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;conn&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;kv&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">wdgs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;num_wdgs&quot;</span><span class="p">]):</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Wdg</span><span class="p">(</span><span class="n">wdgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;kva&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kva&quot;</span><span class="p">)))</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;kv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kv&quot;</span><span class="p">)))</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;conn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;conn&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data_dict</span></div>


<div class="viewcode-block" id="AutomatedThermalUpgrade"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade">[docs]</a><span class="k">class</span> <span class="nc">AutomatedThermalUpgrade</span><span class="p">(</span><span class="n">AbstractPostprocess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class is used to determine thermal upgrades</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REQUIRED_INPUT_FIELDS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;line_loading_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;line_safety_margin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;xfmr_safety_margin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nominal_voltage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tps_to_test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;create_upgrades_library&quot;</span><span class="p">,</span>
        <span class="s2">&quot;upgrade_library_path&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dssInstance</span><span class="p">,</span> <span class="n">dssSolver</span><span class="p">,</span> <span class="n">dssObjects</span><span class="p">,</span> <span class="n">dssObjectsByClass</span><span class="p">,</span> <span class="n">simulationSettings</span><span class="p">,</span> <span class="n">Logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutomatedThermalUpgrade</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dssInstance</span><span class="p">,</span> <span class="n">dssSolver</span><span class="p">,</span> <span class="n">dssObjects</span><span class="p">,</span> <span class="n">dssObjectsByClass</span><span class="p">,</span> <span class="n">simulationSettings</span><span class="p">,</span> <span class="n">Logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;units key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;kft&quot;</span><span class="p">,</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;Ft&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;cm&quot;</span><span class="p">]</span>  <span class="c1"># Units key for lines taken from OpenDSS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_dss_files_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dss_files_path</span>

        <span class="n">dss</span> <span class="o">=</span> <span class="n">dssInstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span> <span class="o">=</span> <span class="n">dssSolver</span>

        <span class="k">if</span> <span class="n">simulationSettings</span><span class="p">[</span><span class="s2">&quot;Project&quot;</span><span class="p">][</span><span class="s2">&quot;Simulation Type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Snapshot&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;Upgrade post-processors are only supported on Snapshot simulations&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># max limit to the number of iterations for the thermal upgrades algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermal_upgrade_iteration_threshold</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Just send this list as input to the upgrades code via DISCO -  this list may be empty or have as many</span>
        <span class="c1"># paths as the user desires - if empty the mults in the &#39;tps_to_test&#39; input will be used else if non-empty</span>
        <span class="c1"># max and min load mults from the load.dss files will be used. Tne tps to test input should always be specified</span>
        <span class="c1"># irrespective of whether it gets used or not</span>

        <span class="c1"># these parameters are used only if multiple load and pv files are present</span>
        <span class="c1"># TODO: only fixed_tps (using tps_to_test list from config) works in this version</span>
        <span class="c1">#  associated function to compute violations need to be changed to make the multiple dss files option work</span>
        <span class="n">use_fixed_tps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_fixed_tps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="s2">&quot;pydss_other_pvs_dss_files&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="s2">&quot;pydss_other_loads_dss_files&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">get_load_pv_mults_individual_object</span><span class="p">()</span>
            <span class="c1"># self.get_load_mults()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="p">,</span> <span class="n">get_transformer_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_lines</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_line_info</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_line_DT_parameters</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Determining thermal upgrades&quot;</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Vsources</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;//This file has all the upgrades determined using the control device placement algorithm </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="c1"># Determine available upgrades - either by looping over the existing feeder or by reading an</span>
        <span class="c1">#  externally created library</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrades_library&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating upgrades library from the feeder&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_available_line_upgrades</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_available_xfmr_upgrades</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Library created&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading external upgrades library&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_available_upgrades</span><span class="p">(</span><span class="s2">&quot;Line_upgrades_library&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_available_upgrades</span><span class="p">(</span><span class="s2">&quot;Transformer_upgrades_library&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Upgrades library created&quot;</span><span class="p">)</span>

        <span class="c1"># PARALLEL LINES AND TRANSFORMERS LIMIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_XFMR_LIMIT</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_LINE_LIMIT</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># adding timeout condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XFMR_VIOLATIONS_TIMEOUT</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># seconds</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span> <span class="o">=</span> <span class="mf">1.0583</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span> <span class="o">=</span> <span class="mf">0.9167</span>
        <span class="n">voltage_threshold_type</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
        <span class="c1"># voltage_upgrade =</span>

        <span class="c1"># use function to determine values to be placed in comparison file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_line_ldg_lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_ldg_lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_result_comparison</span><span class="p">(</span>
            <span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span><span class="p">[</span><span class="s2">&quot;Equipment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Initial_loading&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Voltages before upgrades max=</span><span class="si">%s</span><span class="s2"> min=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusMagPu</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusMagPu</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Substation power before upgrades: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">TotalPower</span><span class="p">())</span>
        <span class="n">num_elms_violated_curr_itr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;num_elms_violated_curr_itr=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">num_elms_violated_curr_itr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span><span class="p">,</span> <span class="s2">&quot;Initial_equipment_loadings&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;initial_violations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Maximum voltage on any bus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span>
            <span class="s2">&quot;Minimum voltage on any bus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">,</span>
            <span class="s2">&quot;Number of buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">),</span>
            <span class="s2">&quot;Number of overvoltage violations buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">),</span>  <span class="c1"># new</span>
            <span class="s2">&quot;Number of undervoltage violations buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">),</span>  <span class="c1"># new</span>
            <span class="s2">&quot;Max line loading observed&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_line_ldg_lst</span><span class="p">),</span>
            <span class="s2">&quot;Max xfmr loading observed&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_ldg_lst</span><span class="p">),</span>
            <span class="s2">&quot;Number of lines with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">),</span>
            <span class="s2">&quot;Number of xfmrs with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_op_plots</span><span class="p">()</span>

        <span class="c1"># if minimum voltage is close to 0, that indicates a problem in the feeder model connectivity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">&lt;=</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Minimum voltage for this feeder is close to 0 p.u. Check feeder connectivity!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># parameter stating status of thermal upgrades - needed or not</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;Thermal Upgrades were needed&#39;</span>  <span class="c1"># status - whether voltage upgrades done or not</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Thermal Upgrades Required.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Thermal Upgrades Required.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span> <span class="o">=</span> <span class="s1">&#39;No Thermal Upgrades needed&#39;</span>  <span class="c1"># status - whether voltage upgrades done or not</span>

        <span class="c1"># Mitigate thermal violations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># if number of violations is very high,  limit it to a small number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_upgrade_iteration</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thermal_upgrade_iteration_threshold</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_upgrade_iteration</span><span class="p">):</span>
            <span class="n">prev_xfmr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span>
            <span class="n">prev_line</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solution Converged: </span><span class="si">{</span><span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">determine_line_ldgs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Determined line loadings.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Number of line violations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">prev_line</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades till this step in debug_upgrades.dss&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dat_file</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line violations increased from </span><span class="si">{</span><span class="n">prev_line</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;during upgrade process&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correct_line_violations</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Corrected line violations.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solution Converged: </span><span class="si">{</span><span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">determine_xfmr_ldgs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Determined xfmr loadings.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of xfmr violations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">prev_xfmr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades till this step in debug_upgrades.dss&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_dat_file</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Xfmr violations increased from </span><span class="si">{</span><span class="n">prev_xfmr</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;during upgrade process&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correct_xfmr_violations</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Corrected xfmr violations.&quot;</span><span class="p">)</span>

            <span class="n">num_elms_violated_curr_itr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iteration Count: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of devices with violations: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">num_elms_violated_curr_itr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Max iterations limit reached, quitting&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># upgrading process is over</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing upgrades to DSS file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_dat_file</span><span class="p">()</span>

        <span class="c1"># clear and redirect dss file - to compute final violations, and get new elements</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;Clear&quot;</span><span class="p">)</span>
        <span class="n">base_dss</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;project_dss_files_path&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Settings</span><span class="p">[</span><span class="s2">&quot;Project&quot;</span><span class="p">][</span><span class="s2">&quot;DSS File&quot;</span><span class="p">])</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">base_dss</span><span class="p">)</span>
        <span class="n">upgrades_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;thermal_upgrades.dss&quot;</span><span class="p">)</span>
        <span class="n">check_redirect</span><span class="p">(</span><span class="n">upgrades_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>

        <span class="c1"># get final loadings - using function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_line_ldg_lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_xfmr_ldg_lst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_result_comparison</span><span class="p">(</span>
            <span class="n">upper_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span><span class="p">[</span><span class="s2">&quot;Equipment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Final_loading&quot;</span>

        <span class="c1"># Get final loadings based on limit mentioned in config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_xfmr_ldgs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_line_ldgs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span><span class="p">,</span> <span class="s2">&quot;Final_equipment_loadings&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_line_ldg_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_line_ldg_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_ldg_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_xfmr_ldg_lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">feeder_head_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
        <span class="n">feeder_head_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">feeder_head_bus</span><span class="p">)</span>
        <span class="n">feeder_head_basekv</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">NumNodes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">feeder_head_basekv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">feeder_head_basekv</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;final_violations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Maximum voltage on any bus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">,</span>
            <span class="s2">&quot;Minimum voltage on any bus&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">,</span>
            <span class="s2">&quot;Number of buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">),</span>
            <span class="s2">&quot;Number of overvoltage violations buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">),</span>  <span class="c1"># new</span>
            <span class="s2">&quot;Number of undervoltage violations buses outside Range </span><span class="si">{}</span><span class="s2"> limits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voltage_threshold_type</span><span class="p">):</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">),</span>  <span class="c1"># new</span>

            <span class="s2">&quot;Max line loading observed&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_line_ldg_lst</span><span class="p">),</span>
            <span class="s2">&quot;Max xfmr loading observed&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_xfmr_ldg_lst</span><span class="p">),</span>
            <span class="s2">&quot;Number of lines with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">),</span>  <span class="c1"># new</span>
            <span class="s2">&quot;Number of xfmrs with violations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">),</span>  <span class="c1"># new</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;Simulation time (seconds)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;Upgrade status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upgrade_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;feederhead_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feeder_head_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">[</span><span class="s2">&quot;feederhead_basekV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feeder_head_basekv</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feeder_parameters</span><span class="p">,</span> <span class="s2">&quot;Thermal_violations_comparison&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_op_plots</span><span class="p">()</span>

        <span class="c1"># Store final results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Simulation Time: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;After upgrades the solution converged: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Voltages after upgrades max=</span><span class="si">%s</span><span class="s2"> min=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusMagPu</span><span class="p">()),</span> <span class="nb">min</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusMagPu</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Substation power after upgrades: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">TotalPower</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_line_ldg_lst</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Starting Line Loadings&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_line_ldg_lst</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ending Line Loadings&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmr_ldg_lst</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Starting Transformer Loadings&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_xfmr_ldg_lst</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ending Transformer Loadings&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;Loading_comparisons.pdf&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing upgrade results&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total time = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="c1"># save new upgraded objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_xfmrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="p">,</span> <span class="n">get_transformer_info</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_lines</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iter_elements</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_line_info</span><span class="p">)}</span>

        <span class="c1"># reformat upgrades dictionary in the format needed by post process code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linecode_lib_reformat</span><span class="p">()</span>

        <span class="c1"># # reformat upgrades dictionary in the format needed by post process code</span>
        <span class="c1"># self.xfmr_lib_reformat()  # TODO for transformer: this can be used directly</span>

        <span class="c1"># Process outputs</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Outputs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Create_plots&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">],</span>
            <span class="s2">&quot;feederhead_name&quot;</span><span class="p">:</span> <span class="n">feeder_head_name</span><span class="p">,</span>
            <span class="s2">&quot;feederhead_basekV&quot;</span><span class="p">:</span> <span class="n">feeder_head_basekv</span><span class="p">,</span>
            <span class="s2">&quot;new_xfmrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_xfmrs</span><span class="p">,</span>
            <span class="s2">&quot;orig_xfmrs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_xfmrs</span><span class="p">,</span>
            <span class="s2">&quot;new_lines&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_lines</span><span class="p">,</span>
            <span class="s2">&quot;orig_lines&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_lines</span><span class="p">,</span>
            <span class="s2">&quot;orig_lc_parameters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_lc_parameters</span><span class="p">,</span>
            <span class="c1"># &quot;orig_line_parameters&quot;: self.orig_line_parameters,  #TODO - reformat and pass to postprocess</span>
            <span class="c1"># &quot;orig_DT_parameters&quot;: self.orig_DT_parameters,  # TODO - reformat and pass to postprocess</span>
        <span class="p">}</span>

        <span class="n">postprocess_thermal_upgrades</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">dss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Convergence</span><span class="p">()</span> <span class="c1"># This is fake for now, find how to get this from Opendssdirect</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_required_input_fields</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">AutomatedThermalUpgrade</span><span class="o">.</span><span class="n">REQUIRED_INPUT_FIELDS</span>

    <span class="c1"># function to determine loading and voltage files to be written out to comparison json file</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.create_result_comparison"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.create_result_comparison">[docs]</a>    <span class="k">def</span> <span class="nf">create_result_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get thermal loadings based on limit mentioned in config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_xfmr_ldgs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_line_ldgs</span><span class="p">()</span>

        <span class="c1"># Get final loadings</span>
        <span class="n">line_ldg_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xfmr_ldg_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">equip_ldgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">line_ldg_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">equip_ldgs</span><span class="p">[</span><span class="s2">&quot;Line_&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">xfmr_ldg_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">equip_ldgs</span><span class="p">[</span><span class="s2">&quot;Xfmr_&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># final computation of violations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_nodal_violations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="n">upper_limit</span><span class="o">=</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="o">=</span><span class="n">lower_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line_ldg_lst</span><span class="p">,</span> <span class="n">xfmr_ldg_lst</span><span class="p">,</span> <span class="n">equip_ldgs</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.get_load_pv_mults_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_load_pv_mults_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_load_pv_mults_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">kW</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kW</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_load_files_get_load_pv_mults_individual_object</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">pmpp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;irradiance&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pmpp</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_pv_files_get_load_pv_mults_individual_object</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dss_paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.read_load_files_get_load_pv_mults_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.read_load_files_get_load_pv_mults_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">read_load_files_get_load_pv_mults_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key_paths</span><span class="p">,</span><span class="n">dss_path</span><span class="p">):</span>

        <span class="c1"># Add all load kW values</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path_f</span> <span class="ow">in</span> <span class="n">dss_path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new load.&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">):</span>
                                <span class="n">ld_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;kw&quot;</span><span class="p">):</span>
                                <span class="n">ld_kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">temp_dict</span><span class="p">[</span><span class="n">ld_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ld_kw</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.read_pv_files_get_load_pv_mults_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.read_pv_files_get_load_pv_mults_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">read_pv_files_get_load_pv_mults_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_paths</span><span class="p">,</span> <span class="n">dss_path</span><span class="p">):</span>
        <span class="c1"># Add all PV pmpp values</span>
        <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path_f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_pv_dss_files</span><span class="p">[</span><span class="n">key_paths</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new pvsystem.&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pvsystem.&quot;</span><span class="p">):</span>
                                <span class="n">pv_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;pvsystem.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;irradiance&quot;</span><span class="p">):</span>
                                <span class="n">pv_pmpp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">temp_dict</span><span class="p">[</span><span class="n">pv_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_pmpp</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.get_load_mults"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_load_mults">[docs]</a>    <span class="k">def</span> <span class="nf">get_load_mults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">kW</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kW</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">dss_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_load_files</span><span class="p">(</span><span class="n">dss_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_min_max_load_mult</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.read_load_files"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.read_load_files">[docs]</a>    <span class="k">def</span> <span class="nf">read_load_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dss_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dss_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new load.&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">):</span>
                            <span class="n">ld_name</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;load.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;kw&quot;</span><span class="p">):</span>
                            <span class="n">ld_kw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ld_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">ld_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ld_kw</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.get_min_max_load_mult"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_min_max_load_mult">[docs]</a>    <span class="k">def</span> <span class="nf">get_min_max_load_mult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span></div>

    <span class="c1"># function to get line information</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.get_line_info"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_line_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_line_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ln_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ln_name</span><span class="p">,</span> <span class="s2">&quot;num_phases&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">(),</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">(),</span>
                     <span class="s2">&quot;ln_b1&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">(),</span> <span class="s2">&quot;ln_b2&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">(),</span>
                     <span class="s2">&quot;len_units&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;units key&quot;</span><span class="p">][</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="s2">&quot;linecode&quot;</span><span class="p">:</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">LineCode</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;linecode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;linecode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;ln_b1&quot;</span><span class="p">])</span>
        <span class="n">kv_b1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;ln_b2&quot;</span><span class="p">])</span>
        <span class="n">kv_b2</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ln_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_b1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_b2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;To and from bus voltages (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match for line </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">kv_b2</span><span class="p">,</span> <span class="n">kv_b1</span><span class="p">,</span> <span class="n">ln_name</span><span class="p">))</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;line_kV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kv_b1</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.read_available_upgrades"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.read_available_upgrades">[docs]</a>    <span class="k">def</span> <span class="nf">read_available_upgrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;upgrade_library_path&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">)),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1"># copied from voltage upgrades code (with some modifications) - used to determine voltage violations</span>
    <span class="c1"># this function checks for voltage violations based on upper and lower limit passed</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.check_voltage_violations_multi_tps"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.check_voltage_violations_multi_tps">[docs]</a>    <span class="k">def</span> <span class="nf">check_voltage_violations_multi_tps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">()</span>
        <span class="c1"># This objective currently gives more weightage if same node has violations at more than 1 time point</span>
        <span class="n">num_nodes_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">severity_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations_pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># If multiple load files are being used, the &#39;tps_to_test property is not used, else if a single load file is</span>
        <span class="c1"># used use the &#39;tps to test&#39; input</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Select that bus voltage of the three phases which is outside bounds the most,</span>
                    <span class="c1">#  else if everything is within bounds use nominal pu voltage.</span>
                    <span class="n">maxv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">minv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">:</span>
                        <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">maxv_dev</span> <span class="o">=</span> <span class="n">maxv</span> <span class="o">-</span> <span class="n">upper_limit</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lower_limit</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">minv_dev</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">-</span> <span class="n">minv</span>
                    <span class="k">if</span> <span class="n">maxv_dev</span> <span class="o">&gt;</span> <span class="n">minv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">maxv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">maxv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="c1"># self.buses_with_violations_pos[b.lower()] = self.pos_dict[b.lower()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">minv_dev</span> <span class="o">&gt;</span> <span class="n">maxv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">minv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">minv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="c1"># self.buses_with_violations_pos[b.lower()] = self.pos_dict[b.lower()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nominal_pu_voltage&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_used</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_used</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write upgrades before Convergence Error in debug_upgrades.dss&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_upgrades_to_file</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;debug_upgrades.dss&quot;</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Select that bus voltage of the three phases which is outside bounds the most,</span>
                    <span class="c1">#  else if everything is within bounds use nominal pu voltage.</span>
                    <span class="n">maxv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">minv_dev</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">busvmax</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">upper_limit</span><span class="p">:</span>
                        <span class="n">maxv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">maxv_dev</span> <span class="o">=</span> <span class="n">maxv</span> <span class="o">-</span> <span class="n">upper_limit</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lower_limit</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                        <span class="n">minv_dev</span> <span class="o">=</span> <span class="n">upper_limit</span> <span class="o">-</span> <span class="n">minv</span>
                    <span class="k">if</span> <span class="n">maxv_dev</span> <span class="o">&gt;</span> <span class="n">minv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">maxv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">maxv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="c1"># self.buses_with_violations_pos[b.lower()] = self.pos_dict[b.lower()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_overvoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">minv_dev</span> <span class="o">&gt;</span> <span class="n">maxv_dev</span><span class="p">:</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="n">minv</span>
                        <span class="n">num_nodes_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">severity_counter</span> <span class="o">+=</span> <span class="n">minv_dev</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="c1"># self.buses_with_violations_pos[b.lower()] = self.pos_dict[b.lower()]</span>
                        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buses_with_undervoltage_violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># v_used = self.config[&quot;nominal_pu_voltage&quot;]</span>
                        <span class="n">v_used</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_used</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodal_violations_dict</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_used</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">severity_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_nodes_counter</span><span class="p">,</span> <span class="n">severity_counter</span><span class="p">,</span> <span class="n">num_nodes_counter</span> <span class="o">*</span> <span class="n">severity_counter</span><span class="p">]</span>
        <span class="k">return</span></div>

    <span class="c1"># (not used) computes nodal violations when we have multipliers for individual Load and PV objects</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.get_nodal_violations_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_nodal_violations_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodal_violations_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the maximum and minimum voltages and number of buses with violations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses</span>          <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span>     <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span>     <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)):</span>
            <span class="c1"># Apply correct pmpp values to all PV systems</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;PV system not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_pmpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit PVsystem.</span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> irradiance=</span><span class="si">{</span><span class="n">new_pmpp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Apply correct kW value to all loads</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenDSS solution did not converge for timepoint &quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">tp_cnt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.get_nodal_violations"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.get_nodal_violations">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodal_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the maximum and minimum voltages and number of buses with violations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buses</span>          <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span>     <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span>     <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buses</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">bus_v</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">puVmagAngle</span><span class="p">()[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_V_viol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_V_viol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">bus_v</span><span class="p">)</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower_thresh</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cust_viol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.create_op_plots"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.create_op_plots">[docs]</a>    <span class="k">def</span> <span class="nf">create_op_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">AllBusNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_edges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;create_upgrade_plots&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correct_node_coords</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Length: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_edge_node_dicts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_feeder</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.correct_node_coords"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.correct_node_coords">[docs]</a>    <span class="k">def</span> <span class="nf">correct_node_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If node doesn&#39;t have node attributes, attach parent or child node&#39;s attributes</span>
        <span class="n">new_temp_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span>
        <span class="n">temp_graph</span> <span class="o">=</span> <span class="n">new_temp_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Vsources</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">new_x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">new_y</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pred_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">pred_buses</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">new_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">new_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Since either predecessor nodes were not available or they did not have</span>
                    <span class="c1"># non-zero coordinates, try successor nodes</span>
                    <span class="c1"># Get a leaf node</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">leaf_node</span> <span class="o">=</span> <span class="n">x</span>
                            <span class="k">break</span>
                    <span class="n">succ_buses</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">temp_graph</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">leaf_node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">succ_buses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pred_bus</span> <span class="ow">in</span> <span class="n">succ_buses</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pred_bus</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                                <span class="n">new_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">new_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">pred_bus</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">]</span>
                                <span class="k">break</span>
        <span class="c1"># Update pos dict with new coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.generate_nodes"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.generate_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">generate_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_bus_names</span><span class="p">:</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">X</span><span class="p">())</span>
            <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">Y</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.generate_edges"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.generate_edges">[docs]</a>    <span class="k">def</span> <span class="nf">generate_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        All lines, switches, reclosers etc are modeled as lines, so calling lines takes care of all of them.</span>
<span class="sd">        However we also need to loop over transformers as they form the edge between primary and secondary nodes</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">bus_names</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
            <span class="n">from_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">to_bus</span> <span class="o">=</span> <span class="n">bus_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
            <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.create_edge_node_dicts"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.create_edge_node_dicts">[docs]</a>    <span class="k">def</span> <span class="nf">create_edge_node_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_to_plt_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_pos_plt_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_size_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_size_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">equip_ldgs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">round</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Line_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Line.&quot;</span><span class="o">+</span><span class="n">key</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edge_to_plt_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">to_bus</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edge_pos_plt_dict</span><span class="p">[</span><span class="n">from_bus</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">from_bus</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edge_pos_plt_dict</span><span class="p">[</span><span class="n">to_bus</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">to_bus</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edge_size_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;xfmr&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">round</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Xfmr_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Transformer.&quot;</span> <span class="o">+</span> <span class="n">key</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">bus_sec</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bus_sec</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DT_size_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_coords</span><span class="p">[</span><span class="n">bus_sec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">[</span><span class="n">bus_sec</span><span class="p">]</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.plot_feeder"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.plot_feeder">[docs]</a>    <span class="k">def</span> <span class="nf">plot_feeder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_size_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">de</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_pos_plt_dict</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_to_plt_dict</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_size_list</span><span class="p">)</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_lst</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_coords</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DT_sec_lst</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DT_size_list</span><span class="p">,</span>
                                        <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;deeppink&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ldn</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dict</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_list</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># nx.draw_networkx_labels(self.G, pos=self.pos_dict, node_size=1, font_size=15)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Thermal violations&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span><span class="s2">&quot;Thermal_violations_</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_violations_counter</span><span class="o">+=</span><span class="mi">1</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.export_line_DT_parameters"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.export_line_DT_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">export_line_DT_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_line_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Linecodes_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originial_xfmr_parameters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># creating dictionary with line parameters</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># first check if lines exist, to avoid segmentation fault</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ln_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">ln_lc</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">LineCode</span><span class="p">()</span>
                <span class="n">ln_geo</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ln_lc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ln_lc</span> <span class="o">=</span> <span class="n">ln_geo</span>

                <span class="c1"># if there are no line codes and geometries defined, create line code with line name</span>
                <span class="k">elif</span> <span class="n">ln_lc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ln_lc</span> <span class="o">=</span> <span class="n">ln_name</span>
                    <span class="n">ampacity</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;normamps&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Linecodes_params</span><span class="p">[</span><span class="n">ln_lc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Ampacity&quot;</span><span class="p">:</span> <span class="n">ampacity</span><span class="p">}</span>

                <span class="n">ln_len</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">()</span>
                <span class="n">len_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;units key&quot;</span><span class="p">][</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#len_units_alt = dss.Properties.Value(&quot;Units&quot;)</span>
                <span class="n">ln_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
                <span class="n">ln_b1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus1</span><span class="p">()</span>
                <span class="n">ln_b2</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Bus2</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">ln_b1</span><span class="p">)</span>
                <span class="n">kv_b1</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">ln_b2</span><span class="p">)</span>
                <span class="n">kv_b2</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ln_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_b1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_b2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;To and from bus voltages (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match for line </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kv_b2</span><span class="p">,</span> <span class="n">kv_b1</span><span class="p">,</span> <span class="n">ln_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_line_parameters</span><span class="p">[</span><span class="n">ln_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linecode&quot;</span><span class="p">:</span><span class="n">ln_lc</span><span class="p">,</span><span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">ln_len</span><span class="p">,</span>
                                                           <span class="s2">&quot;num_phases&quot;</span><span class="p">:</span> <span class="n">ln_phases</span><span class="p">,</span><span class="s2">&quot;line_kV&quot;</span><span class="p">:</span> <span class="n">kv_b1</span><span class="p">,</span>
                                                           <span class="s2">&quot;length_unit&quot;</span><span class="p">:</span><span class="n">len_units</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_line_parameters</span><span class="p">,</span> <span class="s2">&quot;Original_line_parameters&quot;</span><span class="p">)</span>

        <span class="c1"># creating a dictionary with line code and geometries parameters</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">LineCodes</span><span class="o">.</span><span class="n">First</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first check if linecodes exist - to avoid segmentation fault</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lc_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">LineCodes</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">ampacity</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">LineCodes</span><span class="o">.</span><span class="n">NormAmps</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Linecodes_params</span><span class="p">[</span><span class="n">lc_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Ampacity&quot;</span><span class="p">:</span><span class="n">ampacity</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">LineCodes</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># Add geometries to this linecodes dict as well</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># first check if Lines exist - to avoid segmentation fault</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ln_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">lc_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">LineCode</span><span class="p">()</span>
                <span class="n">ln_geo</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">lc_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># if line geometry exists for this line</span>
                    <span class="n">lc_name</span> <span class="o">=</span> <span class="n">ln_geo</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveClass</span><span class="p">(</span><span class="s2">&quot;linegeometry&quot;</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">geo</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">geo</span> <span class="o">==</span> <span class="n">lc_name</span><span class="p">:</span>
                            <span class="n">ampacity</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;normamps&quot;</span><span class="p">)</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Linecodes_params</span><span class="p">[</span><span class="n">lc_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Ampacity&quot;</span><span class="p">:</span> <span class="n">ampacity</span><span class="p">}</span>
                <span class="c1"># else if line codes and line geometries do not exist, nothing to be done. Move to next line</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">ln_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Linecodes_params</span><span class="p">,</span> <span class="s2">&quot;Original_linecodes_parameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">dt_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">dt_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;Phases&quot;</span><span class="p">)</span>
                <span class="n">dt_numwdgs</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">NumWindings</span><span class="p">()</span>
                <span class="n">dt_kva</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dt_conn</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dt_kv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">wdgs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dt_numwdgs</span><span class="p">):</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Wdg</span><span class="p">(</span><span class="n">wdgs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dt_kva</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kva&quot;</span><span class="p">)))</span>
                    <span class="n">dt_kv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kv&quot;</span><span class="p">)))</span>
                    <span class="n">dt_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;conn&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">originial_xfmr_parameters</span><span class="p">[</span><span class="n">dt_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_phases&quot;</span><span class="p">:</span><span class="n">dt_phases</span><span class="p">,</span><span class="s2">&quot;num_windings&quot;</span><span class="p">:</span> <span class="n">dt_numwdgs</span><span class="p">,</span>
                                                           <span class="s2">&quot;wdg_kvas&quot;</span><span class="p">:</span> <span class="n">dt_kva</span><span class="p">,</span><span class="s2">&quot;wdg_kvs&quot;</span><span class="p">:</span> <span class="n">dt_kv</span><span class="p">,</span><span class="s2">&quot;wdg_conns&quot;</span><span class="p">:</span> <span class="n">dt_conn</span><span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">originial_xfmr_parameters</span><span class="p">,</span> <span class="s2">&quot;Original_xfmr_parameters&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.write_to_json"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.write_to_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.write_dat_file"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.write_dat_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_dat_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">],</span> <span class="s2">&quot;thermal_upgrades.dss&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span><span class="p">:</span>
                <span class="n">datafile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

    <span class="c1"># this function reformats linecode library in the format needed by postprocess_thermal_upgrades code</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.linecode_lib_reformat"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.linecode_lib_reformat">[docs]</a>    <span class="k">def</span> <span class="nf">linecode_lib_reformat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># flatten upgrades library dictionary - to convert to same dictionary structure as that needed for postprocess</span>
        <span class="n">modified_lib_linecode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">modified_lib_linecode</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># converting dictionary value format to same as that needed for postprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_lc_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">modified_lib_linecode</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Ampacity&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_lc_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_available_line_upgrades"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_available_line_upgrades">[docs]</a>    <span class="k">def</span> <span class="nf">determine_available_line_upgrades</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">First</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
                <span class="n">line_code</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">LineCode</span><span class="p">()</span>
                <span class="n">ln_geo</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
                <span class="n">param_name</span> <span class="o">=</span> <span class="n">line_code</span>
                <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;linecode&quot;</span>
                <span class="k">if</span> <span class="n">line_code</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;geometry&quot;</span>
                    <span class="n">param_name</span> <span class="o">=</span> <span class="n">ln_geo</span>
                    <span class="c1"># TODO: Distinguish between overhead and underground cables, currently there is no way to</span>
                    <span class="c1">#  distinguish using opendssdirect/pydss etc</span>
                    <span class="c1"># dss.Circuit.SetActiveClass(&quot;linegeometry&quot;)</span>
                    <span class="c1"># flag = dss.ActiveClass.First()</span>
                    <span class="c1"># while flag&gt;0:</span>
                    <span class="c1">#     self.logger.info(&quot;%s %s %s %s&quot;, dss.ActiveClass.Name(),dss.Properties.Value(&quot;wire&quot;),</span>
                    <span class="c1">#     dss.Properties.Value(&quot;cncable&quot;),dss.Properties.Value(&quot;tscable&quot;))</span>
                    <span class="c1">#     flag = dss.ActiveClass.Next()</span>
                <span class="k">elif</span> <span class="n">line_code</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;line_definition&quot;</span>
                    <span class="n">param_name</span> <span class="o">=</span> <span class="n">line_name</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
                <span class="n">norm_amps</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                <span class="c1"># TODO change this to properties</span>
                <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">from_bus</span><span class="p">)</span>
                <span class="n">kv_from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">to_bus</span><span class="p">)</span>
                <span class="n">kv_to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_from_bus</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_to_bus</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;For line </span><span class="si">{}</span><span class="s2"> the from and to bus kV (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match, quitting...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_name</span><span class="p">,</span>
                                                                                                        <span class="n">kv_from_bus</span><span class="p">,</span>
                                                                                                        <span class="n">kv_to_bus</span><span class="p">))</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;type_&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ln_config</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">kv_from_bus</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

                <span class="c1"># add parameters, from line code, geometry or line definition</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">):</span> <span class="p">[</span><span class="n">norm_amps</span><span class="p">]}</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lc_key</span><span class="p">,</span> <span class="n">lc_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_dict</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_amps</span><span class="p">]</span>

                <span class="c1"># Check and remove commented lines - replacement added above</span>
                <span class="c1"># # Add linecodes</span>
                <span class="c1"># if key not in self.avail_line_upgrades and ln_config==&quot;linecode&quot;:</span>
                <span class="c1">#     self.avail_line_upgrades[key] = {&quot;{}&quot;.format(line_code):[norm_amps]}</span>
                <span class="c1"># elif key in self.avail_line_upgrades and ln_config==&quot;linecode&quot;:</span>
                <span class="c1">#     for lc_key,lc_dict in self.avail_line_upgrades.items():</span>
                <span class="c1">#         if line_code not in lc_dict:</span>
                <span class="c1">#             self.avail_line_upgrades[key][&quot;{}&quot;.format(line_code)]=[norm_amps]</span>
                <span class="c1"># # Add line geometries</span>
                <span class="c1"># if key not in self.avail_line_upgrades and ln_config == &quot;geometry&quot;:</span>
                <span class="c1">#     self.avail_line_upgrades[key] = {&quot;{}&quot;.format(ln_geo): [norm_amps]}</span>
                <span class="c1"># elif key in self.avail_line_upgrades and ln_config == &quot;geometry&quot;:</span>
                <span class="c1">#     for lc_key, lc_dict in self.avail_line_upgrades.items():</span>
                <span class="c1">#         if ln_geo not in lc_dict:</span>
                <span class="c1">#             self.avail_line_upgrades[key][&quot;{}&quot;.format(ln_geo)] = [norm_amps]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_line_ldgs"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_line_ldgs">[docs]</a>    <span class="k">def</span> <span class="nf">determine_line_ldgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_diff_tps_lines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

    <span class="c1"># (not used) solves when we have multipliers for individual Load and PV objects</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.solve_diff_tps_lines_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.solve_diff_tps_lines_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">solve_diff_tps_lines_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Uses Kwami&#39;s logic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PVsystems: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)):</span>
            <span class="c1"># Apply correct pmpp values to all PV systems</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;PV system not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_pmpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit PVsystem.</span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> irradiance=</span><span class="si">{</span><span class="n">new_pmpp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Apply correct kW value to all loads</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenDSS solution did not converge for timepoint &quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">tp_cnt</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveClass</span><span class="p">(</span><span class="s2">&quot;Line&quot;</span><span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">switch</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">)</span>
                <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                <span class="n">line_limit</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                <span class="n">line_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ldg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">line_limit</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>  <span class="c1"># and switch==False:</span>
                    <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span></div>

    <span class="c1"># this function solves using list of tps_to_test</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.solve_diff_tps_lines"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.solve_diff_tps_lines">[docs]</a>    <span class="k">def</span> <span class="nf">solve_diff_tps_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Uses Kwami&#39;s logic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PVsystems: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TotalPower=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">TotalPower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveClass</span><span class="p">(</span><span class="s2">&quot;Line&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">switch</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">)</span>
                    <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">line_limit</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                    <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                    <span class="n">line_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ldg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">line_limit</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>  <span class="c1"># and switch==False:</span>
                        <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TotalPower=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">TotalPower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveClass</span><span class="p">(</span><span class="s2">&quot;Line&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">switch</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">)</span>
                    <span class="n">line_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">line_limit</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                    <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                    <span class="n">line_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">ldg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)</span><span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">line_limit</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">all_line_ldgs_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">switch</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span><span class="p">:</span>  <span class="c1"># and switch==False:</span>
                        <span class="k">if</span> <span class="n">line_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">)],</span> <span class="n">line_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">line_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">line_violations_alltps</span><span class="p">[</span><span class="n">line_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">ActiveClass</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.correct_line_violations"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.correct_line_violations">[docs]</a>    <span class="k">def</span> <span class="nf">correct_line_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This finds a line code which provides a specified safety margin to a line above its maximum observed loading.</span>
        <span class="c1"># If a line code is not found or if line code is too overrated one or more parallel lines (num_par_lns-1)</span>
        <span class="c1"># may be added.</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_violations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Phases</span><span class="p">()</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Length</span><span class="p">()</span>
                <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;units key&quot;</span><span class="p">][</span><span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Units</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">line_code</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">LineCode</span><span class="p">()</span>
                <span class="n">ln_geo</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Lines</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
                <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;linecode&quot;</span>
                <span class="k">if</span> <span class="n">line_code</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">line_code</span> <span class="o">=</span> <span class="n">ln_geo</span>
                    <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;geometry&quot;</span>
                <span class="c1"># if there are no line codes and geometries defined, create line code with line name</span>
                <span class="k">elif</span> <span class="n">line_code</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">ln_geo</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ln_config</span> <span class="o">=</span> <span class="s2">&quot;line_definition&quot;</span>
                    <span class="n">line_code</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">from_bus</span><span class="p">)</span>
                <span class="n">kv_from_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveBus</span><span class="p">(</span><span class="n">to_bus</span><span class="p">)</span>
                <span class="n">kv_to_bus</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Bus</span><span class="o">.</span><span class="n">kVBase</span><span class="p">()</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Circuit</span><span class="o">.</span><span class="n">SetActiveElement</span><span class="p">(</span><span class="s2">&quot;Line.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">norm_amps</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
                <span class="n">num_par_lns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_safety_margin&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_from_bus</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">round</span><span class="p">(</span><span class="n">kv_to_bus</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;For line </span><span class="si">{}</span><span class="s2"> the from and to bus kV (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match, quitting...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                                                                                        <span class="n">kv_from_bus</span><span class="p">,</span>
                                                                                                        <span class="n">kv_to_bus</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">norm_amps</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.001</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;For line </span><span class="si">{}</span><span class="s2"> the rated current values (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match, quitting...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                                                                                          <span class="n">norm_amps</span><span class="p">,</span>
                                                                                                          <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">lc_key</span> <span class="o">=</span> <span class="s2">&quot;type_&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ln_config</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">kv_from_bus</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">lcs_fnd_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">lc_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">lcs</span><span class="p">,</span><span class="n">lcs_vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span><span class="p">[</span><span class="n">lc_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">lcs</span><span class="o">!=</span><span class="n">line_code</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">lcs_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">((</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_safety_margin&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">lcs_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">num_par_lns</span><span class="o">*</span><span class="n">norm_amps</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ln_config</span> <span class="o">==</span> <span class="s1">&#39;line_definition&#39;</span><span class="p">:</span>
                                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Line.</span><span class="si">{lnm}</span><span class="s2"> normamps=</span><span class="si">{ampacity}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lnm</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                  <span class="n">ampacity</span><span class="o">=</span><span class="n">lcs_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>  <span class="c1"># if line code and line geometry is available</span>
                                    <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Line.</span><span class="si">{lnm}</span><span class="s2"> </span><span class="si">{cnfig}</span><span class="s2">=</span><span class="si">{lnc}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lnm</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">cnfig</span><span class="o">=</span><span class="n">ln_config</span><span class="p">,</span>
                                                                                            <span class="n">lnc</span><span class="o">=</span><span class="n">lcs</span><span class="p">)</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="n">lcs_fnd_flag</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">lc_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_line_upgrades</span> <span class="ow">or</span> <span class="n">lcs_fnd_flag</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Add parallel lines since no suitable (correct ampacity/ratings or economical) line</span>
                    <span class="c1"># replacement was found</span>
                    <span class="c1"># number of parallel lines should be less than limit</span>
                    <span class="k">if</span> <span class="n">num_par_lns</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_LINE_LIMIT</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of parallel lines determined is </span><span class="si">{</span><span class="n">num_par_lns</span><span class="si">}</span><span class="s2">. &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;This is greater than limit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_LINE_LIMIT</span><span class="si">}</span><span class="s2"> parallel &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;lines allowed&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">ln_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_par_lns</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">curr_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ln_config</span> <span class="o">==</span> <span class="s1">&#39;line_definition&#39;</span><span class="p">:</span>
                            <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Line.</span><span class="si">{lnm}</span><span class="s2">_upgrade_</span><span class="si">{tr_cnt}</span><span class="s2">_</span><span class="si">{cnt}</span><span class="s2">_</span><span class="si">{tm}</span><span class="s2"> bus1=</span><span class="si">{b1}</span><span class="s2"> bus2=</span><span class="si">{b2}</span><span class="s2"> length=</span><span class="si">{lt}</span><span class="s2"> units=</span><span class="si">{u}</span><span class="s2">&quot;</span> \
                                             <span class="s2">&quot; phases=</span><span class="si">{ph}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">lnm</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">tr_cnt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span><span class="p">,</span> <span class="n">cnt</span><span class="o">=</span><span class="n">ln_cnt</span><span class="p">,</span> <span class="n">tm</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">,</span>
                                <span class="n">b1</span><span class="o">=</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">to_bus</span><span class="p">,</span> <span class="n">lt</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ph</span><span class="o">=</span><span class="n">phases</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if line code and line geometry is available</span>
                            <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Line.</span><span class="si">{lnm}</span><span class="s2">_upgrade_</span><span class="si">{tr_cnt}</span><span class="s2">_</span><span class="si">{cnt}</span><span class="s2">_</span><span class="si">{tm}</span><span class="s2"> bus1=</span><span class="si">{b1}</span><span class="s2"> bus2=</span><span class="si">{b2}</span><span class="s2"> length=</span><span class="si">{lt}</span><span class="s2"> units=</span><span class="si">{u}</span><span class="s2">&quot;</span> \
                                             <span class="s2">&quot; </span><span class="si">{cnfig}</span><span class="s2">=</span><span class="si">{lc}</span><span class="s2"> phases=</span><span class="si">{ph}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">lnm</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">tr_cnt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span><span class="p">,</span> <span class="n">cnt</span><span class="o">=</span><span class="n">ln_cnt</span><span class="p">,</span> <span class="n">tm</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">,</span>
                                <span class="n">b1</span><span class="o">=</span><span class="n">from_bus</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">to_bus</span><span class="p">,</span> <span class="n">lt</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">cnfig</span><span class="o">=</span><span class="n">ln_config</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="n">line_code</span><span class="p">,</span> <span class="n">ph</span><span class="o">=</span><span class="n">phases</span>
                            <span class="p">)</span>

                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This DPV penetration has no line violations&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_available_xfmr_upgrades"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_available_xfmr_upgrades">[docs]</a>    <span class="k">def</span> <span class="nf">determine_available_xfmr_upgrades</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If the kVA ratings for the windings do not match, the DT is not considered as a potential upgrade option.</span>
        <span class="c1">#  For this DT the upgrade will either be one or more DTs of its own ratings in parallel or a new DT with</span>
        <span class="c1">#  higher ratings but each winding will be of equal rating.</span>
        <span class="c1"># Get a unique id descriptive of DT number of phases, number of wdgs; wdg kvs and connections</span>
        <span class="c1"># Get essential DT characteristics: kVA, normal amps rating, %r for both windings to capture percent load loss,</span>
        <span class="c1"># and % noload loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ignore_upgrade</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span>
            <span class="c1"># Figure out unique DT characteristics so possible upgrade options may be determined: key is: num phases;</span>
            <span class="c1"># num wdgs; kv and connection of each winding</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
            <span class="n">num_wdgs</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">NumWindings</span><span class="p">()</span>
            <span class="n">norm_amps</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NormalAmps</span><span class="p">()</span>
            <span class="n">conn_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wdg_kva_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">wdg_kv_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">per_R_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">per_losses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">per_reac</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xhl&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">num_wdgs</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xht&quot;</span><span class="p">))</span>
                <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xlt&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">wdgs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">):</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Wdg</span><span class="p">(</span><span class="n">wdgs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wdg_kva_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kva&quot;</span><span class="p">)))</span>
                <span class="n">wdg_kv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kv&quot;</span><span class="p">)))</span>
                <span class="n">conn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;conn&quot;</span><span class="p">))</span>
                <span class="n">per_R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">per_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;%noloadloss&quot;</span><span class="p">))</span>
            <span class="n">per_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%lo</span><span class="s2">adloss&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">per_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="nb">float</span><span class="p">(</span><span class="n">per_losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">pct_nl</span> <span class="o">=</span> <span class="n">per_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pct_l</span> <span class="o">=</span> <span class="n">per_losses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For DT </span><span class="si">{</span><span class="n">xfmr_name</span><span class="si">}</span><span class="s2">, pct_noloadloss </span><span class="si">{</span><span class="n">pct_nl</span><span class="si">}</span><span class="s2"> is greater than %loadloss </span><span class="si">{</span><span class="n">pct_l</span><span class="si">}</span><span class="s2">, continuing...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wdg_kva_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">wdg_kva_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; DT </span><span class="si">%s</span><span class="s2"> will not be considered as a upgrade option as the kVA values of its&quot;</span> \
                          <span class="s2">&quot; windings do not match </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xfmr_name</span><span class="p">,</span><span class="n">wdg_kva_list</span><span class="p">)</span>
                    <span class="n">ignore_upgrade</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ignore_upgrade</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;type_&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wdg_kv_list</span><span class="p">)):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdg_kv_list</span><span class="p">[</span><span class="n">kv_cnt</span><span class="p">])</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conn_list</span><span class="p">[</span><span class="n">kv_cnt</span><span class="p">])</span>
            <span class="c1"># Get relevant parameters for each potential upgrade option</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">xfmr_name</span><span class="p">:[</span><span class="n">wdg_kva_list</span><span class="p">,[</span><span class="n">norm_amps</span><span class="p">],</span><span class="n">per_R_list</span><span class="p">,</span><span class="n">per_losses</span><span class="p">,</span><span class="n">per_reac</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">wdg_kva_list</span><span class="p">,[</span><span class="n">norm_amps</span><span class="p">],</span><span class="n">per_R_list</span><span class="p">,</span><span class="n">per_losses</span><span class="p">,</span><span class="n">per_reac</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_xfmr_ldgs"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_xfmr_ldgs">[docs]</a>    <span class="k">def</span> <span class="nf">determine_xfmr_ldgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: team please correct the logic used for determining DT loadings. This is the same logic Nicolas</span>
        <span class="c1"># TODO: used for the SETO project. This may break down for some DT configurations such as 3 wdg transformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_xfmr_ldgs_alltps</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

    <span class="c1"># (not used) computes violations when we have multipliers for individual Load and PV objects</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_xfmr_ldgs_alltps_individual_object"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_xfmr_ldgs_alltps_individual_object">[docs]</a>    <span class="k">def</span> <span class="nf">determine_xfmr_ldgs_alltps_individual_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)):</span>
            <span class="c1"># Apply correct pmpp values to all PV systems</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">pv_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pv_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;PV system not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_pmpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_pvs</span><span class="p">[</span><span class="n">pv_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edit PVsystem.</span><span class="si">{</span><span class="n">pv_name</span><span class="si">}</span><span class="s2"> irradiance=</span><span class="si">{</span><span class="n">new_pmpp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">PVsystems</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="c1"># Apply correct kW value to all loads</span>
            <span class="k">if</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                    <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_loads</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
            <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># Kwami&#39;s approach</span>
                <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                <span class="n">hs_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">kva</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVA&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n_phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span><span class="p">)</span>
                <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                <span class="n">xfmr_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">max_flow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)</span>
                <span class="n">ldg</span> <span class="o">=</span> <span class="n">max_flow</span> <span class="o">/</span> <span class="n">xfmr_limit</span>
                <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span></div>

    <span class="c1"># this function is used to determine loadings - using a list of tps provided in config</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.determine_xfmr_ldgs_alltps"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.determine_xfmr_ldgs_alltps">[docs]</a>    <span class="k">def</span> <span class="nf">determine_xfmr_ldgs_alltps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># apply common multipliers to all load dss files - unsure what happens here</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">load_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Load not found, quitting...&quot;</span><span class="p">)</span>
                        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_max_load_kw</span><span class="p">[</span><span class="n">load_name</span><span class="p">][</span><span class="n">tp_cnt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">kW</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Loads</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># Kwami&#39;s approach</span>
                    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">hs_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">kva</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVA&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">n_phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span><span class="p">)</span>
                    <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                    <span class="n">xfmr_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">max_flow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)</span>
                    <span class="n">ldg</span> <span class="o">=</span> <span class="n">max_flow</span> <span class="o">/</span> <span class="n">xfmr_limit</span>
                    <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="c1"># if other load dss files are not present, apply these multipliers to the current load and pv case</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_load_dss_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tp_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">])):</span>
                <span class="c1"># First two tps are for disabled PV case</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=False&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tp_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;BatchEdit PVSystem..* Enabled=True&quot;</span><span class="p">)</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s2">&quot;set LoadMult = </span><span class="si">{LM}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LM</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tps_to_test&quot;</span><span class="p">][</span><span class="n">tp_cnt</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Solution</span><span class="o">.</span><span class="n">Converged</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">OpenDssConvergenceError</span><span class="p">(</span><span class="s2">&quot;OpenDSS solution did not converge&quot;</span><span class="p">)</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">First</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">xfmr_name</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">Name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c1"># Kwami&#39;s approach</span>
                    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                    <span class="n">hs_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">kva</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVA&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">n_phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xfmr_limit</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span><span class="p">)</span>
                    <span class="n">Currents</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">CurrentsMagAng</span><span class="p">()[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_phases</span><span class="p">]</span>
                    <span class="n">xfmr_current</span> <span class="o">=</span> <span class="n">Currents</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">max_flow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)</span>
                    <span class="n">ldg</span> <span class="o">=</span> <span class="n">max_flow</span> <span class="o">/</span> <span class="n">xfmr_limit</span>
                    <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_xfmr_ldgs_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ldg</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">xfmr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">)],</span> <span class="n">xfmr_limit</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">xfmr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations_alltps</span><span class="p">[</span><span class="n">xfmr_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xfmr_current</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">return</span></div>

    <span class="c1"># this function raises exception if time limit is exceeded in a particular loop/function</span>
<div class="viewcode-block" id="AutomatedThermalUpgrade.time_limit_exception"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.time_limit_exception">[docs]</a>    <span class="k">def</span> <span class="nf">time_limit_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expire_time</span><span class="p">,</span> <span class="n">exception_message</span><span class="o">=</span><span class="s1">&#39;Time limit exceeded&#39;</span><span class="p">):</span>
        <span class="c1"># if time limit is exceeded, then raise exception</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">expire_time</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exception_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.correct_xfmr_violations"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.correct_xfmr_violations">[docs]</a>    <span class="k">def</span> <span class="nf">correct_xfmr_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This finds a line code which provides a specified safety margin to a line above its maximum observed loading.</span>
        <span class="c1"># If a line code is not found or if line code is too overrated one or more parallel lines (num_par_lns-1)</span>
        <span class="c1"># may be added.</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xfmr_violations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># add timeout limit  - raise exception if exceeds more than a certain time in seconds</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">expire_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">XFMR_VIOLATIONS_TIMEOUT</span>
                <span class="c1"># Determine which category this DT belongs to</span>
                <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                <span class="n">num_wdgs</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">NumWindings</span><span class="p">()</span>
                <span class="c1">#Kwami&#39;s logic</span>
                <span class="n">n_phases</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">NumPhases</span><span class="p">()</span>
                <span class="n">hs_kv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">kva</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;kVA&#39;</span><span class="p">))</span>
                <span class="n">lead_lag</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;leadlag&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_phases</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">norm_amps</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">norm_amps</span> <span class="o">=</span> <span class="n">kva</span> <span class="o">/</span> <span class="p">(</span><span class="n">hs_kv</span><span class="p">)</span>
                <span class="n">conn_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">wdg_kva_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">wdg_kv_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">per_R_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">per_losses</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">per_reac</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xhl&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">num_wdgs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xht&quot;</span><span class="p">))</span>
                    <span class="n">per_reac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;xlt&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">wdgs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">):</span>
                    <span class="n">dss</span><span class="o">.</span><span class="n">Transformers</span><span class="o">.</span><span class="n">Wdg</span><span class="p">(</span><span class="n">wdgs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">wdg_kva_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kva&quot;</span><span class="p">)))</span>
                    <span class="n">wdg_kv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;kv&quot;</span><span class="p">)))</span>
                    <span class="n">conn_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;conn&quot;</span><span class="p">))</span>
                    <span class="n">per_R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="n">buses_list</span> <span class="o">=</span> <span class="n">dss</span><span class="o">.</span><span class="n">CktElement</span><span class="o">.</span><span class="n">BusNames</span><span class="p">()</span>
                <span class="n">per_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dss</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;%noloadloss&quot;</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">time_limit_exception</span><span class="p">(</span><span class="n">expire_time</span><span class="o">=</span><span class="n">expire_time</span><span class="p">,</span> <span class="n">exception_message</span><span class="o">=</span><span class="s2">&quot;Time Limit exceeded in function &quot;</span>
                                                                                <span class="s2">&quot;to mitigate transformer violations.&quot;</span><span class="p">)</span>
                <span class="c1"># per_losses.append(dss.Properties.Value(&quot;%loadloss&quot;))</span>
                <span class="c1"># if per_losses[0] &gt; per_losses[1]:</span>
                <span class="c1">#     self.logger.info(&quot;For DT %s, %noloadloss is greater than %loadloss %s, continuing...&quot;, key, per_losses)</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">norm_amps</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s2">&quot;For DT </span><span class="si">{}</span><span class="s2"> the rated current values (</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">) do not match, quitting...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>
                                                                                                          <span class="n">norm_amps</span><span class="p">,</span>
                                                                                                          <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">num_par_dts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;xfmr_safety_margin&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dt_loading_limit&quot;</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">dt_key</span> <span class="o">=</span> <span class="s2">&quot;type_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kv_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wdg_kv_list</span><span class="p">)):</span>
                    <span class="n">dt_key</span> <span class="o">=</span> <span class="n">dt_key</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdg_kv_list</span><span class="p">[</span><span class="n">kv_cnt</span><span class="p">])</span>
                    <span class="n">dt_key</span> <span class="o">=</span> <span class="n">dt_key</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conn_list</span><span class="p">[</span><span class="n">kv_cnt</span><span class="p">])</span>
                <span class="c1"># Find potential upgrades for this DT. This might be a new higher kVA rated DT in place of the original</span>
                <span class="c1"># or one or more parallel DTs</span>
                <span class="n">dt_fnd_flag</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dt_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span><span class="n">dt_vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span><span class="p">[</span><span class="n">dt_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">dt</span><span class="o">!=</span><span class="n">key</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dt_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">((</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;xfmr_safety_margin&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;line_loading_limit&quot;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">dt_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">num_par_dts</span><span class="o">*</span><span class="n">norm_amps</span><span class="p">:</span>
                                <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;Edit Transformer.</span><span class="si">{xf}</span><span class="s2"> %noloadloss=</span><span class="si">{nll}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xf</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                                                                                  <span class="n">nll</span><span class="o">=</span><span class="n">dt_vals</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">wdgs_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">):</span>
                                    <span class="n">wdg_str</span> <span class="o">=</span> <span class="s2">&quot;wdg=</span><span class="si">{wdg_cnt}</span><span class="s2"> kVA=</span><span class="si">{wdg_kva}</span><span class="s2"> </span><span class="si">%r</span><span class="s2">=</span><span class="si">{wdg_r}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdg_cnt</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">wdgs_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                                                                               <span class="n">wdg_kva</span> <span class="o">=</span> <span class="n">dt_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">wdgs_cnt</span><span class="p">],</span>
                                                                                               <span class="n">wdg_r</span> <span class="o">=</span> <span class="n">dt_vals</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">wdgs_cnt</span><span class="p">])</span>
                                    <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="n">wdg_str</span>
                                <span class="k">if</span> <span class="n">num_wdgs</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                                    <span class="n">per_reac_str</span> <span class="o">=</span> <span class="s2">&quot;XLT=</span><span class="si">{xlt}</span><span class="s2"> XHT=</span><span class="si">{xht}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xlt</span><span class="o">=</span><span class="n">dt_vals</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                                                <span class="n">xht</span><span class="o">=</span><span class="n">dt_vals</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="n">per_reac_str</span>
                                <span class="n">add_str</span> <span class="o">=</span> <span class="s2">&quot;XHL=</span><span class="si">{xhl}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xhl</span><span class="o">=</span><span class="n">dt_vals</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                                <span class="n">dt_fnd_flag</span><span class="o">=</span><span class="mi">1</span>
                                <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">time_limit_exception</span><span class="p">(</span><span class="n">expire_time</span><span class="o">=</span><span class="n">expire_time</span><span class="p">,</span> <span class="n">exception_message</span><span class="o">=</span><span class="s2">&quot;Time Limit exceeded in function &quot;</span>
                                                                                <span class="s2">&quot;to mitigate transformer violations.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">dt_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avail_xfmr_upgrades</span> <span class="ow">or</span> <span class="n">dt_fnd_flag</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Add parallel DTs since no suitable (correct ratings or economical) DT replacement was found</span>

                    <span class="c1"># number of parallel transformers should be less than limit</span>
                    <span class="k">if</span> <span class="n">num_par_dts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_XFMR_LIMIT</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of parallel transformers determined is </span><span class="si">{</span><span class="n">num_par_dts</span><span class="si">}</span><span class="s2">. &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;This is greater than limit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARALLEL_XFMR_LIMIT</span><span class="si">}</span><span class="s2"> parallel &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;transformers allowed&quot;</span><span class="p">)</span>
                    <span class="n">curr_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">curr_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">dt_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_par_dts</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">command_string</span> <span class="o">=</span> <span class="s2">&quot;New Transformer.</span><span class="si">{dtn}</span><span class="s2">_upgrade_</span><span class="si">{tr_cnt}</span><span class="s2">_</span><span class="si">{cnt}</span><span class="s2">_</span><span class="si">{tm}</span><span class="s2"> phases=</span><span class="si">{phs}</span><span class="s2"> windings=</span><span class="si">{wdgs}</span><span class="s2">&quot;</span> \
                                         <span class="s2">&quot; %noloadloss=</span><span class="si">{nll}</span><span class="s2"> leadlag=</span><span class="si">{ll}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">dtn</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                            <span class="n">tr_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line_trial_counter</span><span class="p">,</span>
                            <span class="n">cnt</span><span class="o">=</span><span class="n">dt_cnt</span><span class="p">,</span>
                            <span class="n">tm</span> <span class="o">=</span> <span class="n">time_stamp</span><span class="p">,</span>
                            <span class="n">phs</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                            <span class="n">wdgs</span><span class="o">=</span><span class="n">num_wdgs</span><span class="p">,</span>
                            <span class="n">nll</span><span class="o">=</span><span class="n">per_losses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">ll</span><span class="o">=</span><span class="n">lead_lag</span>
                        <span class="p">)</span>

                        <span class="k">for</span> <span class="n">wdgs_cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_wdgs</span><span class="p">):</span>
                            <span class="n">wdg_str</span> <span class="o">=</span> <span class="s2">&quot;wdg=</span><span class="si">{numwdg}</span><span class="s2"> bus=</span><span class="si">{bus_wdg}</span><span class="s2"> kv=</span><span class="si">{wdgs_kv}</span><span class="s2"> kVA=</span><span class="si">{wdgs_kva}</span><span class="s2"> </span><span class="si">%r</span><span class="s2">=</span><span class="si">{wdgs_r}</span><span class="s2"> conn=</span><span class="si">{cn}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">numwdg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">wdgs_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                <span class="n">bus_wdg</span><span class="o">=</span><span class="n">buses_list</span><span class="p">[</span><span class="n">wdgs_cnt</span><span class="p">],</span>
                                <span class="n">wdgs_kv</span><span class="o">=</span><span class="n">wdg_kv_list</span><span class="p">[</span><span class="n">wdgs_cnt</span><span class="p">],</span>
                                <span class="n">wdgs_kva</span> <span class="o">=</span> <span class="n">wdg_kva_list</span><span class="p">[</span><span class="n">wdgs_cnt</span><span class="p">],</span>
                                <span class="n">wdgs_r</span><span class="o">=</span><span class="n">per_R_list</span><span class="p">[</span><span class="n">wdgs_cnt</span><span class="p">],</span>
                                <span class="n">cn</span><span class="o">=</span><span class="n">conn_list</span><span class="p">[</span><span class="n">wdgs_cnt</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">command_string</span><span class="o">=</span><span class="n">command_string</span> <span class="o">+</span> <span class="n">wdg_str</span>
                        <span class="k">if</span> <span class="n">num_wdgs</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">per_reac_str</span> <span class="o">=</span> <span class="s2">&quot;XLT=</span><span class="si">{xlt}</span><span class="s2"> XHT=</span><span class="si">{xht}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xlt</span><span class="o">=</span><span class="n">per_reac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                                         <span class="n">xht</span><span class="o">=</span><span class="n">per_reac</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">command_string</span> <span class="o">=</span> <span class="n">command_string</span> <span class="o">+</span> <span class="n">per_reac_str</span>
                        <span class="n">add_str</span> <span class="o">=</span> <span class="s2">&quot;XHL=</span><span class="si">{xhl}</span><span class="s2"> enabled=True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xhl</span><span class="o">=</span><span class="n">per_reac</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">command_string</span><span class="o">=</span><span class="n">command_string</span><span class="o">+</span><span class="n">add_str</span>
                        <span class="n">dss</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dssSolver</span><span class="o">.</span><span class="n">Solve</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span><span class="o">.</span><span class="n">RunStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_dss_file</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">time_limit_exception</span><span class="p">(</span><span class="n">expire_time</span><span class="o">=</span><span class="n">expire_time</span><span class="p">,</span> <span class="n">exception_message</span><span class="o">=</span><span class="s2">&quot;Time Limit exceeded in function &quot;</span>
                                                                                     <span class="s2">&quot;to mitigate transformer violations.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This DPV penetration has no Transformer thermal violations&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.write_dss_file"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.write_dss_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_dss_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dss_upgrades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device_command</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.run"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">stepMax</span><span class="p">,</span> <span class="n">simulation</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running thermal upgrade post process&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
            <span class="n">has_converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>

            <span class="c1">#step-=1 # uncomment the line if the post process needs to rerun for the same point in time</span>
            <span class="k">return</span> <span class="n">step</span><span class="p">,</span> <span class="n">has_converged</span><span class="p">,</span> <span class="n">error</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AutomatedThermalUpgrade.finalize"><a class="viewcode-back" href="../../../../PyDSS/PyDSS.pyPostprocessor.PostprocessScripts.html#PyDSS.pyPostprocessor.PostprocessScripts.AutomatedThermalUpgrade.AutomatedThermalUpgrade.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method used to combine post processing results from all steps.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Aadil Latif.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>